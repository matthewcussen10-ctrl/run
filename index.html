<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Running Route Generator</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            overflow: hidden;
        }
        #map { width:100vw; height:100vh; position:fixed; top:0; left:0; z-index:1; }

        .controls-panel {
            position:fixed; bottom:0; left:0; right:0; z-index:10;
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(10px);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
        }
        .controls-panel.collapsed { transform: translateY(calc(100% - 50px)); }
        .controls-header {
            padding:12px 20px;
            display:flex; justify-content:space-between; align-items:center;
            cursor:pointer; border-bottom: 1px solid #e8e8e8;
        }
        .controls-panel.collapsed .controls-header { border-bottom:none; }
        .controls-title { font-weight:600; color:#333; font-size:0.9em; text-transform:uppercase; letter-spacing:0.5px; }
        .collapse-icon { width:24px; height:24px; display:flex; align-items:center; justify-content:center; color:#666; transition: transform 0.3s ease; }
        .controls-panel.collapsed .collapse-icon { transform:rotate(180deg); }

        .controls-content { padding:12px 20px 15px; max-height:33vh; overflow-y:auto; }
        .controls-grid {
            max-width:1600px; margin:0 auto;
            display:grid; grid-template-columns: auto auto auto auto 1fr auto;
            gap:12px; align-items:start;
        }

        .control-group { background:#f8f9fa; padding:10px 12px; border-radius:10px; }
        .control-group-title { font-size:0.65em; font-weight:600; color:#666; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px; }

        .toggle-container { display:flex; gap:4px; background:#e8e8e8; padding:2px; border-radius:8px; }
        .toggle-btn {
            flex:1; padding:6px 10px; background:transparent; border:none;
            border-radius:6px; font-weight:600; font-size:0.75em; cursor:pointer;
            color:#666; text-transform:uppercase; letter-spacing:0.3px; white-space:nowrap;
            transition: all 0.2s;
        }
        .toggle-btn.active { background:#fff; color:#333; box-shadow:0 2px 6px rgba(0,0,0,0.1); }

        .terrain-chips { display:flex; flex-wrap:wrap; gap:5px; }
        .terrain-chip {
            padding:6px 10px; background:#fff; border:2px solid #e8e8e8;
            border-radius:20px; cursor:pointer; font-weight:600; font-size:0.7em; color:#666;
            display:flex; align-items:center; gap:4px; transition:all 0.2s;
            user-select: none; -webkit-user-select: none;
        }
        .terrain-chip:hover { border-color:#ccc; }
        .terrain-chip.active { background:#333; color:#fff; border-color:#333; }

        select {
            width:100%; padding:10px 12px; background:#fff; border:2px solid #e8e8e8;
            border-radius:8px; font-size:0.8em; font-weight:500; color:#333; cursor:pointer;
        }

        input[type="range"] { width:100%; height:5px; border-radius:5px; background:#e0e0e0; outline:none; -webkit-appearance:none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance:none; width:16px; height:16px; border-radius:50%; background:#333; cursor:pointer; }
        .slider-with-value { display:flex; align-items:center; gap:10px; }
        .slider-with-value input[type="range"] { flex:1; }
        .slider-value { font-size:1.3em; font-weight:700; color:#333; min-width:65px; text-align:right; }
        .slider-value .unit { font-size:0.55em; font-weight:500; color:#999; margin-left:3px; }

        .btn {
            width:100%; padding:12px 16px; background:#333; color:#fff; border:none;
            border-radius:10px; font-size:0.85em; font-weight:600; cursor:pointer;
            text-transform:uppercase; letter-spacing:0.5px; transition:all 0.2s;
        }
        .btn:hover { background:#000; }
        .btn:disabled { opacity:0.5; cursor:not-allowed; }

        .top-btn {
            position:fixed; left:20px;
            background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
            border:none; width:48px; height:48px; border-radius:12px;
            box-shadow:0 4px 20px rgba(0,0,0,0.15);
            cursor:pointer; display:flex; align-items:center; justify-content:center;
            z-index:10; font-size:1.3em; transition:all 0.2s;
        }
        .top-btn:hover { background:#fff; transform:scale(1.05); }
        .top-btn .badge {
            position:absolute; top:4px; right:4px;
            background:#333; color:#fff; font-size:0.42em; font-weight:700;
            min-width:16px; height:16px; border-radius:8px;
            display:flex; align-items:center; justify-content:center;
        }
        #savedBtn { top:20px; }
        #exploreBtn { top:80px; }
        #buildBtn { top:140px; }

        .drawer {
            position:fixed; top:0; left:0; width:400px; height:100vh;
            background:rgba(255,255,255,0.97); backdrop-filter:blur(14px);
            box-shadow:4px 0 24px rgba(0,0,0,0.18);
            z-index:20; transform:translateX(-100%);
            transition:transform 0.3s cubic-bezier(.4,0,.2,1);
            display:flex; flex-direction:column;
        }
        .drawer.open { transform:translateX(0); }

        .drawer-header {
            display:flex; justify-content:space-between; align-items:center;
            padding:20px 18px 14px; border-bottom:1px solid #eee;
        }
        .drawer-header h3 { font-size:1em; font-weight:600; color:#333; text-transform:uppercase; letter-spacing:0.5px; }
        .drawer-close {
            background:none; border:none; color:#666; cursor:pointer;
            font-size:1.4em; padding:2px 6px; border-radius:6px;
        }

        .drawer-content { flex:1; overflow-y:auto; padding:10px 12px; }

        .explore-tabs {
            display:flex; gap:4px; padding:0 12px 10px; border-bottom:1px solid #eee;
        }
        .explore-tab {
            flex:1; padding:8px; background:transparent; border:none;
            border-radius:8px; font-weight:600; font-size:0.75em; color:#666;
            cursor:pointer; text-transform:uppercase; transition:all 0.2s;
        }
        .explore-tab.active { background:#f0f0f0; color:#333; }

        .route-card {
            background:#fff; border-radius:12px; padding:12px;
            margin-bottom:10px; border:1px solid #e8e8e8;
            cursor:pointer; transition:all 0.2s;
        }
        .route-card:hover { border-color:#ccc; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
        .route-card-title { font-weight:600; font-size:0.9em; color:#333; margin-bottom:8px; }
        .route-card-desc { font-size:0.75em; color:#666; margin-bottom:8px; line-height:1.4; }
        .route-card-stats {
            display:flex; gap:12px; font-size:0.75em; color:#666;
            flex-wrap:wrap;
        }
        .route-card-tags {
            display:flex; gap:4px; flex-wrap:wrap; margin-top:8px;
        }
        .tag {
            background:#f0f0f0; color:#666; padding:2px 8px;
            border-radius:12px; font-size:0.65em; font-weight:600;
        }

        .info-card {
            position:fixed; top:20px; right:20px;
            background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
            padding:16px 18px; border-radius:15px;
            box-shadow:0 8px 32px rgba(0,0,0,0.15);
            z-index:10; min-width:280px; max-width:320px; display:none;
        }
        .info-card.visible { display:block; }
        .info-item { 
            display:flex; justify-content:space-between; 
            padding:5px 0; border-bottom:1px solid #f0f0f0; font-size:0.8em; 
        }
        .info-item:last-child { border-bottom:none; }
        .info-label { font-weight:500; color:#666; }
        .info-value { color:#333; font-weight:600; }

        .info-actions { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:14px; }
        .info-actions .btn { padding:10px; font-size:0.75em; }
        .btn-navigate { background:#f59e0b; grid-column:1/-1; }
        .btn-navigate:hover { background:#d97706; }

        .nav-panel {
            position:fixed; top:20px; left:50%; transform:translateX(-50%);
            background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
            padding:14px 18px; border-radius:15px;
            box-shadow:0 8px 32px rgba(0,0,0,0.15);
            z-index:15; min-width:320px; max-width:400px;
            display:none;
        }
        .nav-panel.visible { display:block; }
        .nav-instruction {
            font-size:1.1em; font-weight:600; color:#333; margin-bottom:8px;
            line-height:1.3;
        }
        .nav-distance { font-size:0.8em; color:#666; margin-bottom:12px; }
        .nav-progress {
            display:flex; gap:8px; padding:10px 0; border-top:1px solid #eee;
        }

        .build-overlay {
            position:fixed; top:20px; left:50%; transform:translateX(-50%);
            background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
            padding:16px 20px; border-radius:15px;
            box-shadow:0 8px 32px rgba(0,0,0,0.15);
            z-index:15; display:none; max-width:400px; width:90%;
        }
        .build-overlay.active { display:block; }

        .modal-overlay {
            position:fixed; inset:0; background:rgba(0,0,0,0.4);
            z-index:30; display:none; align-items:center; justify-content:center;
        }
        .modal-overlay.open { display:flex; }
        .modal { 
            background:#fff; border-radius:16px; padding:24px; 
            width:90%; max-width:450px; box-shadow:0 12px 40px rgba(0,0,0,0.2);
            max-height:80vh; overflow-y:auto;
        }
        .modal h3 { font-size:1em; font-weight:600; color:#333; margin-bottom:14px; }
        .modal input[type="text"], .modal textarea {
            width:100%; padding:10px 12px; border:2px solid #e8e8e8;
            border-radius:8px; font-size:0.9em; font-weight:500; color:#333;
            outline:none; transition:border-color 0.2s; font-family:inherit;
        }
        .modal textarea { resize:vertical; min-height:80px; }
        .modal-actions { display:flex; gap:8px; margin-top:16px; }
        .modal-actions .btn { flex:1; padding:10px; font-size:0.8em; }
        .form-group { margin-bottom:14px; }
        .form-group label { margin-bottom:6px; display:block; font-size:0.75em; font-weight:600; color:#666; text-transform:uppercase; }

        .rating-stars { display:flex; gap:4px; margin-top:8px; }
        .star { cursor:pointer; font-size:1.2em; color:#ddd; transition:color 0.2s; }
        .star.filled { color:#fbbf24; }

        .loading, .error, .success {
            text-align:center; padding:8px; font-size:0.75em; margin-top:8px; border-radius:8px;
        }
        .loading { color:#666; }
        .error { background:#fff5f5; color:#e53e3e; }
        .success { background:#f0fdf4; color:#16a34a; }

        @media (max-width:768px) {
            .controls-grid { grid-template-columns:1fr; }
            .drawer { width:85vw; }
            .nav-panel, .build-overlay { left:10px; right:10px; transform:none; max-width:none; }
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <button class="top-btn" id="savedBtn" onclick="toggleDrawer('saved')">ğŸ—‚ï¸<span class="badge" id="savedBadge" style="display:none;"></span></button>
    <button class="top-btn" id="exploreBtn" onclick="toggleDrawer('explore')">ğŸŒ</button>
    <button class="top-btn" id="buildBtn" onclick="startBuildMode()">âœï¸</button>

    <div class="drawer" id="savedDrawer">
        <div class="drawer-header">
            <h3>My Routes</h3>
            <button class="drawer-close" onclick="closeDrawers()">Ã—</button>
        </div>
        <div class="drawer-content" id="savedList"></div>
    </div>

    <div class="drawer" id="exploreDrawer">
        <div class="drawer-header">
            <h3>Explore Routes</h3>
            <button class="drawer-close" onclick="closeDrawers()">Ã—</button>
        </div>
        <div class="explore-tabs">
            <button class="explore-tab active" data-tab="popular">Popular</button>
            <button class="explore-tab" data-tab="nearby">Nearby</button>
            <button class="explore-tab" data-tab="community">Community</button>
        </div>
        <div class="drawer-content" id="exploreList"></div>
    </div>

    <div id="routeInfo"></div>

    <div class="nav-panel" id="navPanel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h4 style="font-size:0.85em; font-weight:600; text-transform:uppercase;">Navigation</h4>
            <button onclick="endNavigation()" style="background:none; border:none; font-size:1.2em; cursor:pointer;">Ã—</button>
        </div>
        <div class="nav-instruction" id="navInstruction">Starting route...</div>
        <div class="nav-distance" id="navDistance"></div>
        <div class="nav-progress">
            <div style="flex:1;">
                <div style="font-size:0.7em; color:#999; text-transform:uppercase;">Progress</div>
                <div id="navProgress" style="font-size:0.85em; font-weight:600; color:#333;">0%</div>
            </div>
            <div style="flex:1;">
                <div style="font-size:0.7em; color:#999; text-transform:uppercase;">Remaining</div>
                <div id="navRemaining" style="font-size:0.85em; font-weight:600; color:#333;">--</div>
            </div>
        </div>
        <button class="btn" onclick="endNavigation()" style="margin-top:10px; background:#ef4444; padding:8px; font-size:0.75em;">End Navigation</button>
    </div>

    <div class="build-overlay" id="buildOverlay">
        <h4 style="font-size:0.9em; font-weight:600; margin-bottom:12px;">Build Custom Route</h4>
        <p style="font-size:0.8em; color:#666; margin-bottom:12px;">Click/tap on the map to add waypoints</p>
        <div id="buildWaypointCount" style="font-size:0.85em; font-weight:600; color:#10b981; margin-bottom:12px;">0 waypoints</div>
        <div style="display:flex; gap:8px;">
            <button class="btn" onclick="cancelBuildMode()" style="background:#f0f0f0; color:#333; padding:8px; font-size:0.75em;">Cancel</button>
            <button class="btn" onclick="openPublishModal(true)" style="padding:8px; font-size:0.75em;">Finish</button>
        </div>
    </div>

    <div class="modal-overlay" id="publishModal">
        <div class="modal">
            <h3>Publish Route</h3>
            <div class="form-group">
                <label>Route Name</label>
                <input type="text" id="publishName" placeholder="e.g. Sunrise Coastal Run" />
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="publishDesc" placeholder="What makes this route special?"></textarea>
            </div>
            <div class="form-group">
                <label>Tags (comma separated)</label>
                <input type="text" id="publishTags" placeholder="e.g. waterfront, scenic, flat" />
            </div>
            <div class="form-group">
                <label>Your Name (optional)</label>
                <input type="text" id="publishAuthor" placeholder="Anonymous" />
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closePublishModal()" style="background:#f0f0f0; color:#333;">Cancel</button>
                <button class="btn" onclick="confirmPublish()">Publish</button>
            </div>
        </div>
    </div>

    <div class="controls-panel" id="controlsPanel">
        <div class="controls-header" onclick="toggleControls()">
            <div class="controls-title">Route Settings</div>
            <div class="collapse-icon">
                <svg width="20" height="20" viewBox="0 0 20 20"><path d="M5 7.5l5 5 5-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
            </div>
        </div>
        <div class="controls-content">
            <div class="controls-grid">
                <div class="control-group">
                    <div class="control-group-title">Mode</div>
                    <div class="toggle-container">
                        <button class="toggle-btn active" id="distanceToggle">Distance</button>
                        <button class="toggle-btn" id="timeToggle">Time</button>
                    </div>
                </div>

                <div class="control-group" id="distanceGroup">
                    <div class="control-group-title">Distance</div>
                    <div class="slider-with-value">
                        <input type="range" id="distance" min="1" max="20" value="5" step="0.1">
                        <div class="slider-value"><span id="distanceValue">5.0</span><span class="unit">km</span></div>
                    </div>
                </div>

                <div class="control-group" id="timeGroup" style="display:none;">
                    <div class="control-group-title">Duration</div>
                    <div class="slider-with-value">
                        <input type="range" id="time" min="10" max="120" value="30" step="1">
                        <div class="slider-value"><span id="timeValue">30</span><span class="unit">min</span></div>
                    </div>
                </div>

                <div class="control-group">
                    <div class="control-group-title">Route Type</div>
                    <select id="routeType">
                        <option value="oneWay">One Way</option>
                        <option value="returnSame" selected>Out & Back</option>
                        <option value="loop">Loop</option>
                    </select>
                </div>

                <div class="control-group">
                    <div class="control-group-title">Terrain</div>
                    <div class="terrain-chips" id="terrainChips">
                        <div class="terrain-chip" data-terrain="park">ğŸŒ³ Park</div>
                        <div class="terrain-chip" data-terrain="waterside">ğŸŒŠ Water</div>
                        <div class="terrain-chip" data-terrain="hill">â›°ï¸ Hill</div>
                        <div class="terrain-chip" data-terrain="scenic">ğŸŒ… Scenic</div>
                    </div>
                </div>

                <div class="control-group">
                    <button class="btn" id="generateBtn">Generate Route</button>
                    <div id="message"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPgzqvSqNMXp3jxTLh4TbyT0IwJd46dbA&libraries=geometry,places"></script>
    <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Global State
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let map, directionsService, directionsRenderer, placesService;
    let userLocation = { lat:-33.8915, lng:151.2767, name:'Bondi Beach' };
    let selectedTerrain = null;
    let currentMode = 'distance';
    let lastRouteData = null;
    let lastDirectionsResult = null;
    let buildModeActive = false;
    let buildWaypoints = [];
    let buildMarkers = [];
    let buildPolyline = null;
    let mapClickListener = null;
    let currentExploreTab = 'popular';
    let navigationActive = false;
    let currentStepIndex = 0;
    let watchId = null;
    let userMarker = null;
    let completedPolyline = null;
    let remainingPolyline = null;
    let isCustomBuild = false;

    const STORAGE_KEY_MY = 'runningRoutes_saved';
    const STORAGE_KEY_COMMUNITY = 'runningRoutes_community';
    const DEFAULT_PACE = 5; // min/km

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Initialize Map
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: userLocation,
            zoom: 15,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: false,
            styles: [{ featureType:'poi', elementType:'labels', stylers:[{visibility:'off'}] }]
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true,
            polylineOptions: { strokeColor: '#333', strokeWeight: 4 }
        });

        placesService = new google.maps.places.PlacesService(map);

        // Get user location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                pos => {
                    userLocation = {
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                        name: 'Your location'
                    };
                    map.setCenter(userLocation);
                },
                () => console.log('Using default location')
            );
        }

        setupEventListeners();
        renderSavedList();
        renderExploreList();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Event Listeners
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function setupEventListeners() {
        // Terrain chips
        document.querySelectorAll('.terrain-chip').forEach(chip => {
            chip.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                if (this.classList.contains('active')) {
                    this.classList.remove('active');
                    selectedTerrain = null;
                } else {
                    document.querySelectorAll('.terrain-chip').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    selectedTerrain = this.dataset.terrain;
                }
            });
        });

        // Mode toggle
        document.getElementById('distanceToggle').addEventListener('click', () => {
            currentMode = 'distance';
            document.getElementById('distanceToggle').classList.add('active');
            document.getElementById('timeToggle').classList.remove('active');
            document.getElementById('distanceGroup').style.display = 'block';
            document.getElementById('timeGroup').style.display = 'none';
        });

        document.getElementById('timeToggle').addEventListener('click', () => {
            currentMode = 'time';
            document.getElementById('timeToggle').classList.add('active');
            document.getElementById('distanceToggle').classList.remove('active');
            document.getElementById('distanceGroup').style.display = 'none';
            document.getElementById('timeGroup').style.display = 'block';
        });

        // Sliders
        document.getElementById('distance').addEventListener('input', e => {
            document.getElementById('distanceValue').textContent = parseFloat(e.target.value).toFixed(1);
        });

        document.getElementById('time').addEventListener('input', e => {
            document.getElementById('timeValue').textContent = e.target.value;
        });

        // Generate button
        document.getElementById('generateBtn').addEventListener('click', generateRoute);

        // Explore tabs
        document.querySelectorAll('.explore-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.explore-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentExploreTab = this.dataset.tab;
                renderExploreList();
            });
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Generate Route - WALKING ONLY, NO TRANSIT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function generateRoute() {
        const messageDiv = document.getElementById('message');
        const btn = document.getElementById('generateBtn');

        try {
            btn.disabled = true;
            messageDiv.innerHTML = '<div class="loading">ğŸ—ºï¸ Generating walking route...</div>';

            const distance = currentMode === 'distance'
                ? parseFloat(document.getElementById('distance').value)
                : (parseInt(document.getElementById('time').value) / 60) * (60 / DEFAULT_PACE);

            const routeType = document.getElementById('routeType').value;

            let result;
            if (routeType === 'loop') {
                result = await generateLoop(userLocation, distance);
            } else {
                result = await generateDirectRoute(userLocation, distance, routeType);
            }

            // CRITICAL: Verify no transit steps
            const hasTransit = result.routes[0].legs.some(leg => 
                leg.steps.some(step => step.travel_mode !== 'WALKING')
            );
            
            if (hasTransit) {
                throw new Error('Route contains non-walking segments. Please try again.');
            }

            directionsRenderer.setDirections(result);
            lastDirectionsResult = result;
            
            const points = extractPoints(result);
            const actualDistance = result.routes[0].legs.reduce((sum, leg) => sum + leg.distance.value, 0) / 1000;
            
            lastRouteData = {
                distance: actualDistance,
                routeType,
                terrain: selectedTerrain,
                location: { ...userLocation },
                points: points.map(p => ({ lat: p.lat(), lng: p.lng() })),
                createdAt: Date.now(),
                directionsResult: result
            };

            showRouteInfo(lastRouteData);
            messageDiv.innerHTML = '<div class="success">âœ“ Walking route generated!</div>';
            setTimeout(() => { messageDiv.innerHTML = ''; }, 2000);

        } catch (err) {
            console.error('Route generation error:', err);
            messageDiv.innerHTML = `<div class="error">âš ï¸ ${err.message}</div>`;
        } finally {
            btn.disabled = false;
        }
    }

    function generateLoop(origin, distanceKm) {
        return new Promise((resolve, reject) => {
            const radius = (distanceKm * 1000) / (2 * Math.PI);
            const waypoints = [];

            for (let i = 0; i < 2; i++) {
                const angle = (i / 2) * 360 + (Math.random() - 0.5) * 60;
                const r = radius * (0.9 + Math.random() * 0.2);
                waypoints.push({
                    location: google.maps.geometry.spherical.computeOffset(
                        new google.maps.LatLng(origin.lat, origin.lng),
                        r,
                        angle
                    ),
                    stopover: false
                });
            }

            directionsService.route({
                origin: new google.maps.LatLng(origin.lat, origin.lng),
                destination: new google.maps.LatLng(origin.lat, origin.lng),
                waypoints: waypoints,
                travelMode: google.maps.TravelMode.WALKING,
                provideRouteAlternatives: false,
                avoidHighways: true,
                avoidTolls: true,
                optimizeWaypoints: true
            }, (res, status) => {
                if (status === 'OK') {
                    resolve(res);
                } else {
                    reject(new Error('Could not generate loop: ' + status));
                }
            });
        });
    }

    function generateDirectRoute(origin, distanceKm, routeType) {
        return new Promise((resolve, reject) => {
            const metres = routeType === 'returnSame' ? distanceKm * 500 : distanceKm * 1000;
            
            const heading = Math.random() * 360;
            const dest = google.maps.geometry.spherical.computeOffset(
                new google.maps.LatLng(origin.lat, origin.lng),
                metres,
                heading
            );

            directionsService.route({
                origin: new google.maps.LatLng(origin.lat, origin.lng),
                destination: routeType === 'returnSame' 
                    ? new google.maps.LatLng(origin.lat, origin.lng)
                    : dest,
                waypoints: routeType === 'returnSame' ? [{ location: dest, stopover: false }] : [],
                travelMode: google.maps.TravelMode.WALKING,
                provideRouteAlternatives: false,
                avoidHighways: true,
                avoidTolls: true
            }, (res, status) => {
                if (status === 'OK') {
                    resolve(res);
                } else {
                    reject(new Error('Could not generate route: ' + status));
                }
            });
        });
    }

    function extractPoints(result) {
        const points = [];
        result.routes[0].legs.forEach(leg => {
            leg.steps.forEach(step => {
                step.path.forEach(pt => points.push(pt));
            });
        });
        return points;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Navigation with Google Maps style directions
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function startNavigation() {
        if (!lastDirectionsResult) {
            alert('No route to navigate');
            return;
        }

        navigationActive = true;
        currentStepIndex = 0;
        document.getElementById('navPanel').classList.add('visible');
        document.getElementById('routeInfo').querySelector('.info-card')?.classList.remove('visible');

        // Clear standard renderer
        directionsRenderer.setDirections({ routes: [] });

        // Create two polylines: completed (gray) and remaining (black)
        const allPoints = lastRouteData.points.map(p => new google.maps.LatLng(p.lat, p.lng));
        
        completedPolyline = new google.maps.Polyline({
            path: [],
            strokeColor: '#999',
            strokeOpacity: 0.4,
            strokeWeight: 4,
            map: map
        });

        remainingPolyline = new google.maps.Polyline({
            path: allPoints,
            strokeColor: '#333',
            strokeWeight: 4,
            map: map
        });

        // Start location tracking
        if (navigator.geolocation) {
            watchId = navigator.geolocation.watchPosition(
                updateNavigationProgress,
                err => console.error('Navigation error:', err),
                { enableHighAccuracy: true, maximumAge: 1000, timeout: 10000 }
            );
        }

        updateNavigationDisplay();
    }

    function updateNavigationDisplay() {
        if (!lastDirectionsResult) return;
        
        const route = lastDirectionsResult.routes[0];
        let stepsSoFar = 0;
        let currentStep = null;

        for (let leg of route.legs) {
            if (currentStepIndex < stepsSoFar + leg.steps.length) {
                currentStep = leg.steps[currentStepIndex - stepsSoFar];
                break;
            }
            stepsSoFar += leg.steps.length;
        }

        if (!currentStep) {
            document.getElementById('navInstruction').textContent = 'âœ“ You have arrived!';
            document.getElementById('navDistance').textContent = '';
            return;
        }

        document.getElementById('navInstruction').innerHTML = currentStep.instructions;
        document.getElementById('navDistance').textContent = currentStep.distance.text;
    }

    function updateNavigationProgress(position) {
        if (!navigationActive || !lastDirectionsResult) return;

        const userPos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);

        // Update user marker
        if (!userMarker) {
            userMarker = new google.maps.Marker({
                position: userPos,
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: '#4285F4',
                    fillOpacity: 1,
                    strokeColor: '#fff',
                    strokeWeight: 3
                },
                zIndex: 1000
            });
        } else {
            userMarker.setPosition(userPos);
        }

        // Calculate progress
        const route = lastDirectionsResult.routes[0];
        const allPoints = lastRouteData.points.map(p => new google.maps.LatLng(p.lat, p.lng));
        
        let closestIndex = 0;
        let minDist = Infinity;
        
        allPoints.forEach((pt, idx) => {
            const dist = google.maps.geometry.spherical.computeDistanceBetween(userPos, pt);
            if (dist < minDist) {
                minDist = dist;
                closestIndex = idx;
            }
        });

        // Update polylines - completed gray, remaining black
        const completed = allPoints.slice(0, closestIndex + 1);
        const remaining = allPoints.slice(closestIndex);
        
        completedPolyline.setPath(completed);
        remainingPolyline.setPath(remaining);

        // Calculate step progress
        let totalDist = route.legs.reduce((sum, leg) => sum + leg.distance.value, 0);
        let coveredDist = 0;
        let stepsSoFar = 0;

        for (let leg of route.legs) {
            for (let step of leg.steps) {
                const stepStart = step.start_location;
                const distToStart = google.maps.geometry.spherical.computeDistanceBetween(userPos, stepStart);
                
                if (distToStart < 30) { // Within 30m of step
                    currentStepIndex = stepsSoFar;
                }
                
                if (stepsSoFar < currentStepIndex) {
                    coveredDist += step.distance.value;
                }
                
                stepsSoFar++;
            }
        }

        const progress = Math.round((coveredDist / totalDist) * 100);
        const remaining = ((totalDist - coveredDist) / 1000).toFixed(1);

        document.getElementById('navProgress').textContent = `${progress}%`;
        document.getElementById('navRemaining').textContent = `${remaining} km`;

        updateNavigationDisplay();
    }

    function endNavigation() {
        navigationActive = false;
        document.getElementById('navPanel').classList.remove('visible');

        if (watchId) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
        }

        if (userMarker) {
            userMarker.setMap(null);
            userMarker = null;
        }

        if (completedPolyline) {
            completedPolyline.setMap(null);
            completedPolyline = null;
        }

        if (remainingPolyline) {
            remainingPolyline.setMap(null);
            remainingPolyline = null;
        }

        // Restore normal route display
        if (lastDirectionsResult) {
            directionsRenderer.setDirections(lastDirectionsResult);
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Build Mode
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function startBuildMode() {
        buildModeActive = true;
        isCustomBuild = true;
        buildWaypoints = [];
        buildMarkers = [];
        
        if (buildPolyline) {
            buildPolyline.setMap(null);
            buildPolyline = null;
        }

        document.getElementById('buildOverlay').classList.add('active');
        document.getElementById('buildWaypointCount').textContent = '0 waypoints';
        closeDrawers();

        mapClickListener = google.maps.event.addListener(map, 'click', function(e) {
            if (!buildModeActive) return;
            
            const latLng = e.latLng;
            buildWaypoints.push(latLng);

            const marker = new google.maps.Marker({
                position: latLng,
                map: map,
                label: {
                    text: String(buildWaypoints.length),
                    color: '#fff',
                    fontWeight: 'bold'
                },
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 12,
                    fillColor: '#10b981',
                    fillOpacity: 1,
                    strokeColor: '#fff',
                    strokeWeight: 2
                }
            });
            buildMarkers.push(marker);

            if (buildPolyline) buildPolyline.setMap(null);
            buildPolyline = new google.maps.Polyline({
                path: buildWaypoints,
                strokeColor: '#10b981',
                strokeWeight: 3,
                map: map
            });

            document.getElementById('buildWaypointCount').textContent = 
                `${buildWaypoints.length} waypoint${buildWaypoints.length === 1 ? '' : 's'}`;
        });
    }

    function cancelBuildMode() {
        buildModeActive = false;
        isCustomBuild = false;
        document.getElementById('buildOverlay').classList.remove('active');

        if (mapClickListener) {
            google.maps.event.removeListener(mapClickListener);
            mapClickListener = null;
        }

        if (buildPolyline) {
            buildPolyline.setMap(null);
            buildPolyline = null;
        }

        buildMarkers.forEach(m => m.setMap(null));
        buildMarkers = [];
        buildWaypoints = [];
    }

    function finishCustomBuild() {
        if (buildWaypoints.length < 2) {
            alert('Add at least 2 waypoints');
            return;
        }

        const waypoints = buildWaypoints.slice(1, -1).map(w => ({ location: w, stopover: false }));
        
        directionsService.route({
            origin: buildWaypoints[0],
            destination: buildWaypoints[buildWaypoints.length - 1],
            waypoints: waypoints,
            travelMode: google.maps.TravelMode.WALKING,
            avoidHighways: true,
            avoidTolls: true
        }, (result, status) => {
            if (status === 'OK') {
                directionsRenderer.setDirections(result);
                lastDirectionsResult = result;
                
                const points = extractPoints(result);
                const distance = result.routes[0].legs.reduce((sum, leg) => sum + leg.distance.value, 0) / 1000;
                
                lastRouteData = {
                    distance: distance,
                    routeType: 'custom',
                    location: { name: 'Custom Route' },
                    points: points.map(p => ({ lat: p.lat(), lng: p.lng() })),
                    custom: true,
                    createdAt: Date.now(),
                    directionsResult: result
                };

                cancelBuildMode();
                // Open publish modal after finishing
                openPublishModal(true);
            } else {
                alert('Could not create route. Try placing waypoints closer together.');
            }
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Publish & Share
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openPublishModal(isFromBuild = false) {
        if (isFromBuild && buildModeActive) {
            finishCustomBuild();
            return;
        }

        if (!lastRouteData) {
            alert('No route to publish');
            return;
        }

        document.getElementById('publishName').value = '';
        document.getElementById('publishDesc').value = '';
        document.getElementById('publishTags').value = '';
        document.getElementById('publishAuthor').value = localStorage.getItem('userName') || '';
        document.getElementById('publishModal').classList.add('open');
    }

    function closePublishModal() {
        document.getElementById('publishModal').classList.remove('open');
    }

    function confirmPublish() {
        const name = document.getElementById('publishName').value.trim();
        const desc = document.getElementById('publishDesc').value.trim();
        const tags = document.getElementById('publishTags').value.split(',').map(t => t.trim()).filter(Boolean);
        const author = document.getElementById('publishAuthor').value.trim() || 'Anonymous';

        if (!name) {
            alert('Please enter a route name');
            return;
        }

        localStorage.setItem('userName', author);

        const community = loadCommunityRoutes();
        const published = {
            id: Date.now().toString(),
            name,
            description: desc,
            tags,
            author,
            ...lastRouteData,
            ratings: [],
            avgRating: 0,
            publishedAt: Date.now()
        };

        community.unshift(published);
        localStorage.setItem(STORAGE_KEY_COMMUNITY, JSON.stringify(community));

        // Also save to my routes
        saveToMyRoutes(published);

        closePublishModal();
        renderExploreList();

        alert('âœ“ Route published to community!');
        
        // Show explore drawer
        setTimeout(() => toggleDrawer('explore'), 300);
    }

    function saveToMyRoutes(route) {
        const myRoutes = loadMyRoutes();
        if (!myRoutes.find(r => r.id === route.id)) {
            myRoutes.unshift(route);
            localStorage.setItem(STORAGE_KEY_MY, JSON.stringify(myRoutes));
            renderSavedList();
        }
    }

    function rateRoute(routeId, rating) {
        const community = loadCommunityRoutes();
        const route = community.find(r => r.id === routeId);
        
        if (route) {
            if (!route.ratings) route.ratings = [];
            route.ratings.push(rating);
            route.avgRating = route.ratings.reduce((a,b) => a+b, 0) / route.ratings.length;
            
            localStorage.setItem(STORAGE_KEY_COMMUNITY, JSON.stringify(community));
            renderExploreList();
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UI Functions
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function showRouteInfo(data) {
        const estimatedTime = Math.round(data.distance * DEFAULT_PACE);
        const typeLabel = data.custom ? 'Custom' : 
                         data.routeType === 'loop' ? 'Loop' : 
                         data.routeType === 'returnSame' ? 'Out & Back' : 'One Way';

        const html = `
            <div class="info-card visible">
                <h3 style="margin-bottom:12px; font-size:0.95em; color:#333;">${escapeHtml(data.name || 'Route Details')}</h3>
                <div style="font-size:0.8em;">
                    <div class="info-item">
                        <span class="info-label">Distance</span>
                        <span class="info-value">${data.distance.toFixed(1)} km</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Est. Time</span>
                        <span class="info-value">${estimatedTime} min</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Avg. Pace</span>
                        <span class="info-value">${DEFAULT_PACE}:00 /km</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Type</span>
                        <span class="info-value">${typeLabel}</span>
                    </div>
                    ${data.terrain ? `
                    <div class="info-item">
                        <span class="info-label">Terrain</span>
                        <span class="info-value">${data.terrain}</span>
                    </div>` : ''}
                </div>
                <div class="info-actions">
                    <button class="btn" onclick="openPublishModal()">ğŸ“¤ Publish</button>
                    <button class="btn" onclick="saveCurrentRoute()">ğŸ’¾ Save</button>
                    ${data.directionsResult ? '<button class="btn btn-navigate" onclick="startNavigation()">ğŸ§­ Navigate</button>' : ''}
                </div>
            </div>
        `;
        document.getElementById('routeInfo').innerHTML = html;
    }

    function saveCurrentRoute() {
        if (!lastRouteData) return;

        const name = prompt('Route name:', `Route ${Date.now()}`);
        if (!name) return;

        const myRoutes = loadMyRoutes();
        const saved = {
            id: Date.now().toString(),
            name,
            ...lastRouteData
        };

        myRoutes.unshift(saved);
        localStorage.setItem(STORAGE_KEY_MY, JSON.stringify(myRoutes));

        renderSavedList();
        alert('âœ“ Route saved!');
    }

    function renderSavedList() {
        const routes = loadMyRoutes();
        const listDiv = document.getElementById('savedList');

        if (routes.length === 0) {
            listDiv.innerHTML = '<div style="padding:40px 20px; text-align:center; color:#999; font-size:0.85em;">No saved routes yet</div>';
            document.getElementById('savedBadge').style.display = 'none';
            return;
        }

        document.getElementById('savedBadge').style.display = 'flex';
        document.getElementById('savedBadge').textContent = routes.length;

        listDiv.innerHTML = routes.map(r => {
            const estTime = Math.round(r.distance * DEFAULT_PACE);
            return `
            <div class="route-card" onclick="loadRoute('${r.id}', 'my')">
                <div class="route-card-title">${escapeHtml(r.name)}</div>
                <div class="route-card-stats">
                    <span>ğŸ“ ${r.distance.toFixed(1)} km</span>
                    <span>â±ï¸ ${estTime} min</span>
                    <span>ğŸ“… ${new Date(r.createdAt).toLocaleDateString()}</span>
                </div>
            </div>
        `}).join('');
    }

    function renderExploreList() {
        const community = loadCommunityRoutes();
        const listDiv = document.getElementById('exploreList');

        let filtered = [];
        
        if (currentExploreTab === 'popular') {
            filtered = community.filter(r => (r.ratings?.length || 0) >= 3 || (r.avgRating || 0) >= 4);
        } else if (currentExploreTab === 'nearby') {
            filtered = community.filter(r => {
                if (!r.location?.lat) return false;
                const dist = google.maps.geometry.spherical.computeDistanceBetween(
                    new google.maps.LatLng(userLocation.lat, userLocation.lng),
                    new google.maps.LatLng(r.location.lat, r.location.lng)
                );
                return dist < 50000; // 50km
            });
        } else {
            filtered = community;
        }

        if (filtered.length === 0) {
            listDiv.innerHTML = `<div style="padding:40px 20px; text-align:center; color:#999; font-size:0.85em;">
                No ${currentExploreTab} routes yet${currentExploreTab === 'community' ? '.<br>Be the first to publish!' : ''}
            </div>`;
            return;
        }

        listDiv.innerHTML = filtered.map(r => {
            const estTime = Math.round(r.distance * DEFAULT_PACE);
            const rating = r.avgRating || 0;
            return `
            <div class="route-card" onclick="loadRoute('${r.id}', 'community')">
                <div class="route-card-title">${escapeHtml(r.name)}</div>
                ${r.description ? `<div class="route-card-desc">${escapeHtml(r.description)}</div>` : ''}
                <div class="route-card-stats">
                    <span>ğŸ“ ${r.distance.toFixed(1)} km</span>
                    <span>â±ï¸ ${estTime} min</span>
                    <span>â­ ${rating.toFixed(1)} (${r.ratings?.length || 0})</span>
                    <span>ğŸ‘¤ ${escapeHtml(r.author || 'Anonymous')}</span>
                </div>
                ${r.tags && r.tags.length > 0 ? `
                <div class="route-card-tags">
                    ${r.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
                </div>` : ''}
            </div>
        `}).join('');
    }

    function loadRoute(id, source) {
        const routes = source === 'my' ? loadMyRoutes() : loadCommunityRoutes();
        const route = routes.find(r => r.id === id);
        if (!route) return;

        if (route.directionsResult) {
            directionsRenderer.setDirections(route.directionsResult);
            lastDirectionsResult = route.directionsResult;
        } else {
            const path = route.points.map(p => new google.maps.LatLng(p.lat, p.lng));
            new google.maps.Polyline({
                path: path,
                strokeColor: '#333',
                strokeWeight: 4,
                map: map
            });
        }

        const bounds = new google.maps.LatLngBounds();
        route.points.forEach(p => bounds.extend(new google.maps.LatLng(p.lat, p.lng)));
        map.fitBounds(bounds);

        lastRouteData = route;
        showRouteInfo(route);
        closeDrawers();
    }

    function loadMyRoutes() {
        try { return JSON.parse(localStorage.getItem(STORAGE_KEY_MY)) || []; }
        catch { return []; }
    }

    function loadCommunityRoutes() {
        try { return JSON.parse(localStorage.getItem(STORAGE_KEY_COMMUNITY)) || []; }
        catch { return []; }
    }

    function toggleDrawer(which) {
        const drawers = ['savedDrawer', 'exploreDrawer'];
        const targetId = which + 'Drawer';

        drawers.forEach(id => {
            const drawer = document.getElementById(id);
            if (id === targetId) {
                drawer.classList.toggle('open');
            } else {
                drawer.classList.remove('open');
            }
        });
    }

    function closeDrawers() {
        document.querySelectorAll('.drawer').forEach(d => d.classList.remove('open'));
    }

    function toggleControls() {
        document.getElementById('controlsPanel').classList.toggle('collapsed');
    }

    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    window.onload = initMap;
    </script>
</body>
</html>
