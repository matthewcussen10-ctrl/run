<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Running Route Generator</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            overflow: hidden;
        }

        #map { width:100vw; height:100vh; position:fixed; top:0; left:0; z-index:1; }

        .controls-panel {
            position:fixed; bottom:0; left:0; right:0; z-index:10;
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(10px);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
        }
        .controls-panel.collapsed { transform: translateY(calc(100% - 50px)); }

        .controls-header {
            padding:12px 20px;
            display:flex; justify-content:space-between; align-items:center;
            cursor:pointer;
            border-bottom: 1px solid #e8e8e8;
        }
        .controls-panel.collapsed .controls-header { border-bottom:none; }

        .controls-title { font-weight:600; color:#333; font-size:0.9em; text-transform:uppercase; letter-spacing:0.5px; }

        .collapse-icon {
            width:24px; height:24px;
            display:flex; align-items:center; justify-content:center;
            color:#666; transition: transform 0.3s ease;
        }
        .controls-panel.collapsed .collapse-icon { transform:rotate(180deg); }

        .controls-content { padding:12px 20px 15px; max-height:33vh; overflow-y:auto; }
        .controls-content::-webkit-scrollbar { width:6px; }
        .controls-content::-webkit-scrollbar-thumb { background:#ddd; border-radius:3px; }

        .controls-grid {
            max-width:1400px; margin:0 auto;
            display:grid;
            grid-template-columns: auto auto auto 1fr auto;
            gap:12px; align-items:start;
        }

        .control-group { background:#f8f9fa; padding:10px 12px; border-radius:10px; }
        .control-group-title { font-size:0.65em; font-weight:600; color:#666; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px; }

        .toggle-container { display:flex; gap:4px; background:#e8e8e8; padding:2px; border-radius:8px; }
        .toggle-btn {
            flex:1; padding:6px 10px; background:transparent; border:none;
            border-radius:6px; font-weight:600; font-size:0.75em; cursor:pointer;
            color:#666; text-transform:uppercase; letter-spacing:0.3px; white-space:nowrap;
            transition: all 0.2s;
        }
        .toggle-btn.active { background:#fff; color:#333; box-shadow:0 2px 6px rgba(0,0,0,0.1); }

        .pace-presets { display:grid; grid-template-columns:repeat(2,1fr); gap:5px; margin-bottom:8px; }
        .pace-btn {
            padding:8px 6px; background:#fff; border:2px solid #e8e8e8;
            border-radius:8px; cursor:pointer; font-weight:600; font-size:0.7em; color:#333;
            display:flex; flex-direction:column; align-items:center; gap:2px; transition:all 0.2s;
        }
        .pace-btn span { font-size:0.8em; font-weight:500; color:#999; }
        .pace-btn.active { background:#f8f9fa; border-color:#333; }
        .pace-btn.active span { color:#666; }

        .custom-pace-input { display:none; margin-top:8px; }
        .custom-pace-input.active { display:block; }

        .pace-input-group {
            display:flex; align-items:center; gap:6px;
            background:#fff; border:2px solid #e8e8e8; border-radius:8px; padding:6px 10px;
        }
        .pace-input-group input {
            width:38px; border:none; font-size:1em; font-weight:600;
            text-align:center; color:#333; background:transparent;
        }
        .pace-input-group input:focus { outline:none; }
        .pace-separator { font-size:1em; font-weight:600; color:#999; }

        label { display:block; font-weight:600; margin-bottom:6px; color:#333; font-size:0.65em; text-transform:uppercase; letter-spacing:0.5px; }

        select {
            width:100%; padding:10px 12px; background:#fff; border:2px solid #e8e8e8;
            border-radius:8px; font-size:0.8em; font-weight:500; color:#333; cursor:pointer;
            appearance:none;
            background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23666' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat:no-repeat; background-position:right 10px center; padding-right:32px;
            transition:all 0.2s;
        }
        select:hover, select:focus { outline:none; border-color:#333; }

        input[type="range"] { width:100%; height:5px; border-radius:5px; background:#e0e0e0; outline:none; -webkit-appearance:none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance:none; width:16px; height:16px; border-radius:50%; background:#333; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.2); }
        input[type="range"]::-moz-range-thumb { width:16px; height:16px; border-radius:50%; background:#333; cursor:pointer; border:none; box-shadow:0 2px 4px rgba(0,0,0,0.2); }

        .slider-with-value { display:flex; align-items:center; gap:10px; }
        .slider-with-value input[type="range"] { flex:1; }
        .slider-value { font-size:1.3em; font-weight:700; color:#333; min-width:65px; text-align:right; white-space:nowrap; }
        .slider-value .unit { font-size:0.55em; font-weight:500; color:#999; margin-left:3px; }

        .btn {
            width:100%; padding:12px 16px; background:#333; color:#fff; border:none;
            border-radius:10px; font-size:0.85em; font-weight:600; cursor:pointer;
            text-transform:uppercase; letter-spacing:0.5px; transition:all 0.2s;
        }
        .btn:hover { background:#000; transform:translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,0.2); }
        .btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; box-shadow:none; }

        .info-card {
            position:fixed; top:20px; right:20px;
            background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
            padding:16px 18px; border-radius:15px;
            box-shadow:0 8px 32px rgba(0,0,0,0.15);
            z-index:10; min-width:260px; display:none;
        }
        .info-card.visible { display:block; }
        .info-card.minimized { display:none; }

        .info-card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .route-info h3 { color:#333; font-size:0.95em; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }

        .close-btn {
            background:none; border:none; color:#666; cursor:pointer;
            padding:4px; display:flex; align-items:center; justify-content:center;
            border-radius:6px; transition:all 0.2s;
        }
        .close-btn:hover { background:#f0f0f0; color:#333; }

        .info-item { display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #f0f0f0; font-size:0.8em; }
        .info-item:last-child { border-bottom:none; }
        .info-label { font-weight:500; color:#666; }
        .info-value { color:#333; font-weight:600; }

        .info-actions { display:flex; gap:8px; margin-top:14px; }
        .info-actions .btn { flex:1; padding:10px 10px; font-size:0.75em; }
        .btn-save { background:#333; }
        .btn-save:hover { background:#000; }
        .btn-export { background:#1a73e8; }
        .btn-export:hover { background:#1558b0; }

        .reopen-info-btn {
            position:fixed; top:20px; right:20px;
            background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
            border:none; width:48px; height:48px; border-radius:12px;
            box-shadow:0 4px 20px rgba(0,0,0,0.15);
            cursor:pointer; display:none; align-items:center; justify-content:center;
            z-index:10; font-size:1.2em; transition:all 0.2s;
        }
        .reopen-info-btn.visible { display:flex; }
        .reopen-info-btn:hover { background:#fff; transform:scale(1.05); }

        .saved-btn {
            position:fixed; top:20px; left:20px;
            background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
            border:none; width:48px; height:48px; border-radius:12px;
            box-shadow:0 4px 20px rgba(0,0,0,0.15);
            cursor:pointer; display:flex; align-items:center; justify-content:center;
            z-index:10; font-size:1.3em; transition:all 0.2s;
        }
        .saved-btn:hover { background:#fff; transform:scale(1.05); }
        .saved-btn .badge {
            position:absolute; top:4px; right:4px;
            background:#333; color:#fff; font-size:0.42em; font-weight:700;
            min-width:16px; height:16px; border-radius:8px;
            display:flex; align-items:center; justify-content:center;
        }

        .saved-drawer {
            position:fixed; top:0; left:0; width:320px; height:100vh;
            background:rgba(255,255,255,0.97); backdrop-filter:blur(14px);
            box-shadow:4px 0 24px rgba(0,0,0,0.18);
            z-index:20; transform:translateX(-100%);
            transition:transform 0.3s cubic-bezier(.4,0,.2,1);
            display:flex; flex-direction:column;
        }
        .saved-drawer.open { transform:translateX(0); }

        .saved-drawer-header {
            display:flex; justify-content:space-between; align-items:center;
            padding:20px 18px 14px; border-bottom:1px solid #eee;
        }
        .saved-drawer-header h3 { font-size:1em; font-weight:600; color:#333; text-transform:uppercase; letter-spacing:0.5px; }

        .drawer-close {
            background:none; border:none; color:#666; cursor:pointer;
            font-size:1.4em; padding:2px 6px; border-radius:6px; transition:background 0.2s;
        }
        .drawer-close:hover { background:#f0f0f0; }

        .saved-list { flex:1; overflow-y:auto; padding:10px 12px; }
        .saved-list::-webkit-scrollbar { width:5px; }
        .saved-list::-webkit-scrollbar-thumb { background:#ddd; border-radius:3px; }

        .saved-item {
            display:flex; align-items:center; gap:10px;
            padding:11px 12px; border-radius:10px; cursor:pointer;
            border:1px solid transparent; transition:all 0.15s;
        }
        .saved-item:hover { background:#f5f5f5; }
        .saved-item.active { background:#f0f7ff; border-color:#1a73e8; }

        .saved-item-icon {
            width:36px; height:36px; border-radius:8px; background:#f0f0f0;
            display:flex; align-items:center; justify-content:center;
            font-size:1.1em; flex-shrink:0;
        }
        .saved-item.active .saved-item-icon { background:#dceaff; }

        .saved-item-info { flex:1; min-width:0; }
        .saved-item-name { font-size:0.85em; font-weight:600; color:#333; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .saved-item-meta { font-size:0.7em; color:#999; margin-top:2px; }

        .saved-item-delete {
            background:none; border:none; color:#ccc; cursor:pointer;
            font-size:1em; padding:4px; border-radius:4px; flex-shrink:0;
            transition:color 0.15s;
        }
        .saved-item-delete:hover { color:#e53e3e; }

        .saved-empty { text-align:center; padding:60px 20px; color:#aaa; font-size:0.82em; }
        .saved-empty-icon { font-size:2.2em; margin-bottom:10px; }

        .modal-overlay {
            position:fixed; inset:0; background:rgba(0,0,0,0.4);
            z-index:30; display:none; align-items:center; justify-content:center;
        }
        .modal-overlay.open { display:flex; }
        .modal { background:#fff; border-radius:16px; padding:24px; width:90%; max-width:340px; box-shadow:0 12px 40px rgba(0,0,0,0.2); }
        .modal h3 { font-size:1em; font-weight:600; color:#333; margin-bottom:14px; }
        .modal input[type="text"] {
            width:100%; padding:10px 12px; border:2px solid #e8e8e8;
            border-radius:8px; font-size:0.9em; font-weight:500; color:#333;
            outline:none; transition:border-color 0.2s;
        }
        .modal input[type="text"]:focus { border-color:#333; }
        .modal-actions { display:flex; gap:8px; margin-top:16px; }
        .modal-actions .btn { flex:1; padding:10px; font-size:0.8em; }
        .btn-cancel { background:#f0f0f0; color:#333; }
        .btn-cancel:hover { background:#e0e0e0; }

        .loading, .error, .success {
            text-align:center; padding:8px; font-weight:500;
            font-size:0.75em; margin-top:8px; border-radius:8px;
        }
        .loading { color:#666; }
        .error { background:#fff5f5; color:#e53e3e; border:1px solid #feb2b2; }
        .success { background:#f0fdf4; color:#16a34a; border:1px solid #bbf7d0; }

        @media (max-width:1024px) {
            .controls-grid { grid-template-columns:1fr 1fr; }
            .control-group:nth-child(4) { grid-column:1 / -1; }
            .control-group:last-child { grid-column:1 / -1; }
        }
        @media (max-width:768px) {
            .controls-grid { grid-template-columns:1fr; }
            .info-card { top:10px; right:10px; min-width:auto; width:220px; padding:12px 14px; }
            .reopen-info-btn { top:10px; right:10px; width:44px; height:44px; }
            .saved-drawer { width:85vw; }
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <button class="saved-btn" id="savedBtn" onclick="toggleSavedDrawer()">
        üóÇÔ∏è<span class="badge" id="savedBadge" style="display:none;"></span>
    </button>

    <div class="saved-drawer" id="savedDrawer">
        <div class="saved-drawer-header">
            <h3>Saved Routes</h3>
            <button class="drawer-close" onclick="toggleSavedDrawer()">√ó</button>
        </div>
        <div class="saved-list" id="savedList"></div>
    </div>

    <div id="routeInfo"></div>
    <button class="reopen-info-btn" id="reopenInfoBtn" onclick="reopenRouteInfo()">üìä</button>

    <div class="modal-overlay" id="saveModal">
        <div class="modal">
            <h3>Save Route</h3>
            <input type="text" id="saveNameInput" placeholder="e.g. Morning Bondi Loop" />
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeSaveModal()">Cancel</button>
                <button class="btn btn-confirm" onclick="confirmSave()">Save</button>
            </div>
        </div>
    </div>

    <div class="controls-panel" id="controlsPanel">
        <div class="controls-header" onclick="toggleControls()">
            <div class="controls-title">Route Settings</div>
            <div class="collapse-icon">
                <svg width="20" height="20" viewBox="0 0 20 20"><path d="M5 7.5l5 5 5-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
            </div>
        </div>
        <div class="controls-content">
            <div class="controls-grid">
                <div class="control-group">
                    <div class="control-group-title">Mode</div>
                    <div class="toggle-container">
                        <button class="toggle-btn active" id="distanceToggle">Distance</button>
                        <button class="toggle-btn" id="timeToggle">Time</button>
                    </div>
                </div>

                <div class="control-group" id="distanceGroup">
                    <div class="control-group-title">Distance</div>
                    <div class="slider-with-value">
                        <input type="range" id="distance" min="1" max="20" value="5" step="0.1">
                        <div class="slider-value"><span id="distanceValue">5.0</span><span class="unit">km</span></div>
                    </div>
                </div>

                <div class="control-group" id="timeGroup" style="display:none;">
                    <div class="control-group-title">Duration</div>
                    <div class="slider-with-value">
                        <input type="range" id="time" min="10" max="120" value="30" step="1">
                        <div class="slider-value"><span id="timeValue">30</span><span class="unit">min</span></div>
                    </div>
                </div>

                <div class="control-group" id="paceGroup" style="display:none;">
                    <div class="control-group-title">Pace</div>
                    <div class="pace-presets">
                        <button class="pace-btn" data-pace="6">Easy<span>6:00</span></button>
                        <button class="pace-btn active" data-pace="5">Mod<span>5:00</span></button>
                        <button class="pace-btn" data-pace="4">Fast<span>4:00</span></button>
                        <button class="pace-btn" data-pace="custom">Custom<span>Set</span></button>
                    </div>
                    <div class="custom-pace-input" id="customPaceInput">
                        <label>Custom (min/km)</label>
                        <div class="pace-input-group">
                            <input type="number" id="paceMinutes" min="3" max="10" value="5" step="1">
                            <span class="pace-separator">:</span>
                            <input type="number" id="paceSeconds" min="0" max="59" value="0" step="15">
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <div class="control-group-title">Route Type</div>
                    <select id="routeType">
                        <option value="oneWay">One Way</option>
                        <option value="returnSame" selected>Out & Back</option>
                        <option value="loop">Loop</option>
                    </select>
                </div>

                <div class="control-group">
                    <button class="btn" id="generateBtn">Generate Route</button>
                    <div id="message"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPgzqvSqNMXp3jxTLh4TbyT0IwJd46dbA&libraries=geometry"></script>
    <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SMOOTH ROUTE GENERATION - creates flowing paths instead of jerky waypoints
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    let map, currentPolyline, currentMarkers = [];
    let hasGeneratedRoute = false;
    let locationResolved = false;
    let lastRoutePoints = [];
    let lastRouteData = null;
    let activeLoadedId = null;

    let currentMode = 'distance';
    let currentPace = 5;
    let userLocation = { lat:-33.8915, lng:151.2767, name:'25 Cox Avenue, Bondi Beach' };

    const distanceSlider  = document.getElementById('distance');
    const distanceValue   = document.getElementById('distanceValue');
    const timeSlider      = document.getElementById('time');
    const timeValue       = document.getElementById('timeValue');
    const generateBtn     = document.getElementById('generateBtn');
    const messageDiv      = document.getElementById('message');
    const routeInfoDiv    = document.getElementById('routeInfo');
    const distanceToggle  = document.getElementById('distanceToggle');
    const timeToggle      = document.getElementById('timeToggle');
    const distanceGroup   = document.getElementById('distanceGroup');
    const timeGroup       = document.getElementById('timeGroup');
    const paceGroup       = document.getElementById('paceGroup');
    const paceMinutes     = document.getElementById('paceMinutes');
    const paceSeconds     = document.getElementById('paceSeconds');
    const routeTypeSelect = document.getElementById('routeType');
    const customPaceInput = document.getElementById('customPaceInput');
    const savedList       = document.getElementById('savedList');
    const savedBadge      = document.getElementById('savedBadge');
    const saveModal       = document.getElementById('saveModal');
    const saveNameInput   = document.getElementById('saveNameInput');

    const STORAGE_KEY = 'runningRoutes_saved';

    function loadSavedRoutes() {
        try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
        catch { return []; }
    }
    function persistRoutes(routes) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(routes));
    }

    function requestLocation() {
        return new Promise(resolve => {
            if (!navigator.geolocation) { locationResolved = true; resolve(userLocation); return; }
            navigator.geolocation.getCurrentPosition(
                pos => {
                    userLocation = { lat:pos.coords.latitude, lng:pos.coords.longitude, name:'Your current location' };
                    locationResolved = true; resolve(userLocation);
                },
                () => { locationResolved = true; resolve(userLocation); },
                { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
            );
        });
    }

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center:userLocation, zoom:15,
            mapTypeControl:false, streetViewControl:false, fullscreenControl:false,
            styles:[{ featureType:'poi', elementType:'labels', stylers:[{visibility:'off'}] }]
        });
        requestLocation().then(loc => map.setCenter(loc));
        renderSavedList();
    }

    function toggleControls() { document.getElementById('controlsPanel').classList.toggle('collapsed'); }

    document.querySelectorAll('.pace-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.pace-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            if (this.dataset.pace === 'custom') {
                customPaceInput.classList.add('active');
                currentPace = (parseInt(paceMinutes.value)||5) + ((parseInt(paceSeconds.value)||0)/60);
            } else {
                customPaceInput.classList.remove('active');
                currentPace = parseFloat(this.dataset.pace);
                paceMinutes.value = Math.floor(currentPace);
                paceSeconds.value = Math.round((currentPace - Math.floor(currentPace))*60);
            }
        });
    });
    paceMinutes.addEventListener('input', () => { currentPace = (parseInt(paceMinutes.value)||5)+((parseInt(paceSeconds.value)||0)/60); });
    paceSeconds.addEventListener('input', () => { currentPace = (parseInt(paceMinutes.value)||5)+((parseInt(paceSeconds.value)||0)/60); });

    distanceToggle.addEventListener('click', () => {
        currentMode='distance';
        distanceToggle.classList.add('active'); timeToggle.classList.remove('active');
        distanceGroup.style.display='block'; timeGroup.style.display='none'; paceGroup.style.display='none';
    });
    timeToggle.addEventListener('click', () => {
        currentMode='time';
        timeToggle.classList.add('active'); distanceToggle.classList.remove('active');
        distanceGroup.style.display='none'; timeGroup.style.display='block'; paceGroup.style.display='block';
    });
    distanceSlider.addEventListener('input', e => { distanceValue.textContent = parseFloat(e.target.value).toFixed(1); });
    timeSlider.addEventListener('input', e => { timeValue.textContent = e.target.value; });

    function clearRoute() {
        if (currentPolyline) { currentPolyline.setMap(null); currentPolyline = null; }
        currentMarkers.forEach(m => m.setMap(null));
        currentMarkers = [];
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SMOOTH ORGANIC ROUTE BUILDER
    // Creates natural flowing paths with gentle curves instead of harsh waypoints
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function generateSmoothRoute(origin, distanceKm, routeType) {
        const distanceMeters = distanceKm * 1000;
        const origin_ = new google.maps.LatLng(origin.lat, origin.lng);
        
        if (routeType === 'loop') {
            // Smooth circular loop with natural variations
            const radius = distanceMeters / (2 * Math.PI);
            const numPoints = Math.max(40, Math.floor(distanceKm * 10)); // More points = smoother
            const path = [];
            const startAngle = Math.random() * 360;
            
            // Use sine waves to create organic variation
            const waveFreq1 = 0.3 + Math.random() * 0.4;
            const waveFreq2 = 0.7 + Math.random() * 0.6;
            const waveAmp = 0.15;
            
            for (let i = 0; i <= numPoints; i++) {
                const t = i / numPoints;
                const angle = startAngle + t * 360;
                
                // Combine two sine waves for natural organic shape
                const wave = Math.sin(t * Math.PI * 2 * waveFreq1) * waveAmp +
                            Math.sin(t * Math.PI * 2 * waveFreq2) * waveAmp * 0.5;
                const r = radius * (1 + wave);
                
                const pt = google.maps.geometry.spherical.computeOffset(origin_, r, angle);
                path.push(pt);
            }
            
            return path;
            
        } else if (routeType === 'returnSame') {
            // Out and back with smooth curve at turnaround
            const heading = Math.random() * 360;
            const halfDist = distanceMeters / 2;
            const numPointsOut = Math.max(20, Math.floor(distanceKm * 5));
            const path = [];
            
            // Gentle curve outbound
            for (let i = 0; i <= numPointsOut; i++) {
                const t = i / numPointsOut;
                const dist = halfDist * t;
                const curvature = Math.sin(t * Math.PI) * 15; // gentle arc
                const pt = google.maps.geometry.spherical.computeOffset(origin_, dist, heading + curvature);
                path.push(pt);
            }
            
            // Smooth turnaround arc
            const turnPoint = path[path.length - 1];
            const turnPoints = 8;
            for (let i = 1; i < turnPoints; i++) {
                const angle = (i / turnPoints) * 180;
                const pt = google.maps.geometry.spherical.computeOffset(turnPoint, 30, heading + 90 + angle);
                path.push(pt);
            }
            
            // Return journey with slight offset for variety
            for (let i = numPointsOut; i >= 0; i--) {
                const t = i / numPointsOut;
                const dist = halfDist * t;
                const curvature = Math.sin(t * Math.PI) * 15;
                const offset = 8; // slight parallel offset
                const pt = google.maps.geometry.spherical.computeOffset(origin_, dist, heading + curvature);
                const pt2 = google.maps.geometry.spherical.computeOffset(pt, offset, heading + 90);
                path.push(pt2);
            }
            
            return path;
            
        } else {
            // One-way with gentle meandering
            const heading = Math.random() * 360;
            const numPoints = Math.max(30, Math.floor(distanceKm * 8));
            const path = [];
            
            // Create smooth meandering path
            const meander1 = Math.random() * 0.5 + 0.3;
            const meander2 = Math.random() * 0.8 + 0.5;
            
            for (let i = 0; i <= numPoints; i++) {
                const t = i / numPoints;
                const dist = distanceMeters * t;
                
                // Two-frequency meander for natural look
                const wiggle = Math.sin(t * Math.PI * 2 * meander1) * 25 +
                              Math.sin(t * Math.PI * 2 * meander2) * 12;
                
                const pt = google.maps.geometry.spherical.computeOffset(origin_, dist, heading + wiggle);
                path.push(pt);
            }
            
            return path;
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // GENERATE BUTTON
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    generateBtn.addEventListener('click', async () => {
        if (!locationResolved) {
            generateBtn.disabled = true;
            messageDiv.innerHTML = '<div class="loading">üìç Getting your location...</div>';
            await requestLocation();
            map.setCenter(userLocation);
        }

        let distance = currentMode==='distance'
            ? parseFloat(distanceSlider.value)
            : (parseInt(timeSlider.value)/60)*(60/currentPace);
        const routeType = routeTypeSelect.value;

        try {
            generateBtn.disabled = true;
            messageDiv.innerHTML = '<div class="loading">üó∫Ô∏è Creating smooth route...</div>';
            clearRoute();
            activeLoadedId = null;

            // Generate smooth flowing path
            const path = generateSmoothRoute(userLocation, distance, routeType);
            lastRoutePoints = path;

            // Draw it
            currentPolyline = new google.maps.Polyline({
                path, geodesic:true, strokeColor:'#333', strokeWeight:4, map
            });

            // Start/end markers
            currentMarkers.push(new google.maps.Marker({
                position: path[0], map,
                icon: { path: google.maps.SymbolPath.CIRCLE, scale:8, fillColor:'#16a34a', fillOpacity:1, strokeColor:'#fff', strokeWeight:2 },
                label: { text:'START', color:'#fff', fontSize:'9px', fontWeight:'bold' }
            }));
            
            if (routeType !== 'loop') {
                currentMarkers.push(new google.maps.Marker({
                    position: path[path.length-1], map,
                    icon: { path: google.maps.SymbolPath.CIRCLE, scale:8, fillColor:'#e53e3e', fillOpacity:1, strokeColor:'#fff', strokeWeight:2 },
                    label: { text:'END', color:'#fff', fontSize:'9px', fontWeight:'bold' }
                }));
            }

            // Fit map
            const bounds = new google.maps.LatLngBounds();
            path.forEach(p => bounds.extend(p));
            map.fitBounds(bounds, 60);

            lastRouteData = {
                distance, routeType,
                location: { ...userLocation },
                mode: currentMode, pace: currentPace,
                points: path.map(p => ({ lat:p.lat(), lng:p.lng() })),
                createdAt: Date.now()
            };

            showRouteInfo(lastRouteData);

            messageDiv.innerHTML = '<div class="success">‚úì Smooth route created!</div>';
            setTimeout(() => { messageDiv.innerHTML=''; }, 2500);

            if (!hasGeneratedRoute) { generateBtn.textContent='New Route'; hasGeneratedRoute=true; }
            document.getElementById('controlsPanel').classList.add('collapsed');

        } catch(err) {
            messageDiv.innerHTML = `<div class="error">‚ö†Ô∏è ${err.message}</div>`;
        } finally {
            generateBtn.disabled = false;
        }
    });

    function exportToGoogleMaps() {
        const pts = lastRoutePoints;
        if (pts.length < 2) return;
        const max = 8;
        const step = Math.max(1, Math.floor(pts.length/(max+2)));
        const origin = pts[0];
        const destination = pts[pts.length-1];
        const wps = [];
        for (let i=step; i<pts.length-1; i+=step) { if(wps.length>=max) break; wps.push(pts[i]); }
        const fmt = p => `${p.lat().toFixed(6)},${p.lng().toFixed(6)}`;
        let url = `https://www.google.com/maps/dir/${fmt(origin)}`;
        wps.forEach(w => { url += `/${fmt(w)}`; });
        url += `/${fmt(destination)}`;
        window.open(url,'_blank');
    }

    function showRouteInfo(data) {
        const { distance, routeType, location, mode, pace } = data;
        const estTime = Math.round(distance * pace);
        const pMin = Math.floor(pace);
        const pSec = Math.round((pace-pMin)*60);
        const paceStr = `${pMin}:${pSec.toString().padStart(2,'0')} /km`;
        const typeLabel = routeType==='oneWay'?'One Way':routeType==='returnSame'?'Out & Back':'Loop';

        let rows = '';
        rows += `<div class="info-item"><span class="info-label">From</span><span class="info-value">${location.name}</span></div>`;
        if (mode==='distance') {
            rows += `<div class="info-item"><span class="info-label">Distance</span><span class="info-value">${distance.toFixed(1)} km</span></div>`;
            rows += `<div class="info-item"><span class="info-label">Est. Time</span><span class="info-value">${estTime} min</span></div>`;
        } else {
            rows += `<div class="info-item"><span class="info-label">Duration</span><span class="info-value">${estTime} min</span></div>`;
            rows += `<div class="info-item"><span class="info-label">Distance</span><span class="info-value">${distance.toFixed(1)} km</span></div>`;
            rows += `<div class="info-item"><span class="info-label">Pace</span><span class="info-value">${paceStr}</span></div>`;
        }
        rows += `<div class="info-item"><span class="info-label">Type</span><span class="info-value">${typeLabel}</span></div>`;

        let saveBtn = activeLoadedId
            ? `<button class="btn btn-save" style="flex:1; opacity:0.5; cursor:default;" disabled>Saved ‚úì</button>`
            : `<button class="btn btn-save" onclick="openSaveModal()">üíæ Save</button>`;

        routeInfoDiv.innerHTML = `
            <div class="info-card visible" id="infoCard">
                <div class="route-info">
                    <div class="info-card-header">
                        <h3>Route Details</h3>
                        <button class="close-btn" onclick="closeRouteInfo()">
                            <svg width="18" height="18" viewBox="0 0 20 20"><path d="M6 6l8 8M14 6l-8 8" stroke="#666" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
                        </button>
                    </div>
                    ${rows}
                    <div class="info-actions">
                        ${saveBtn}
                        <button class="btn btn-export" onclick="exportToGoogleMaps()">üó∫Ô∏è Maps</button>
                    </div>
                </div>
            </div>`;
    }

    function closeRouteInfo() {
        const card = document.getElementById('infoCard');
        if (card) { card.classList.remove('visible'); card.classList.add('minimized'); }
        document.getElementById('reopenInfoBtn').classList.add('visible');
    }
    function reopenRouteInfo() {
        const card = document.getElementById('infoCard');
        if (card) { card.classList.remove('minimized'); card.classList.add('visible'); }
        document.getElementById('reopenInfoBtn').classList.remove('visible');
    }

    function openSaveModal() {
        const typeNames = { oneWay:'One Way', returnSame:'Out & Back', loop:'Loop' };
        const loc = lastRouteData?.location?.name || 'Route';
        const shortLoc = loc === 'Your current location' ? 'My Location' : loc.split(',')[0];
        saveNameInput.value = `${shortLoc} ${typeNames[lastRouteData?.routeType]} ‚Äì ${lastRouteData?.distance.toFixed(1)}km`;
        saveModal.classList.add('open');
        setTimeout(() => saveNameInput.focus(), 50);
    }
    function closeSaveModal() { saveModal.classList.remove('open'); }

    function confirmSave() {
        const name = saveNameInput.value.trim();
        if (!name || !lastRouteData) return;

        const routes = loadSavedRoutes();
        const saved = { id: Date.now().toString(), name, ...lastRouteData };
        routes.unshift(saved);
        persistRoutes(routes);

        activeLoadedId = saved.id;
        closeSaveModal();
        renderSavedList();
        showRouteInfo(lastRouteData);
    }

    function toggleSavedDrawer() {
        document.getElementById('savedDrawer').classList.toggle('open');
    }

    function renderSavedList() {
        const routes = loadSavedRoutes();

        if (routes.length > 0) {
            savedBadge.style.display = 'flex';
            savedBadge.textContent = routes.length;
        } else {
            savedBadge.style.display = 'none';
        }

        if (routes.length === 0) {
            savedList.innerHTML = `
                <div class="saved-empty">
                    <div class="saved-empty-icon">üèÉ‚Äç‚ôÇÔ∏è</div>
                    No saved routes yet.<br>Generate a route and tap <strong>Save</strong> to add it here.
                </div>`;
            return;
        }

        const typeIcons = { oneWay:'‚Üí', returnSame:'‚ÜîÔ∏è', loop:'üîÑ' };
        savedList.innerHTML = routes.map(r => {
            const date = new Date(r.createdAt);
            const dateStr = date.toLocaleDateString(undefined, { month:'short', day:'numeric' });
            const active = r.id === activeLoadedId ? ' active' : '';
            return `
                <div class="saved-item${active}" onclick="loadSavedRoute('${r.id}')">
                    <div class="saved-item-icon">${typeIcons[r.routeType] || 'üìç'}</div>
                    <div class="saved-item-info">
                        <div class="saved-item-name">${escapeHtml(r.name)}</div>
                        <div class="saved-item-meta">${r.distance.toFixed(1)} km ¬∑ ${dateStr}</div>
                    </div>
                    <button class="saved-item-delete" onclick="event.stopPropagation(); deleteSavedRoute('${r.id}')">üóëÔ∏è</button>
                </div>`;
        }).join('');
    }

    function escapeHtml(str) {
        const d = document.createElement('div');
        d.textContent = str;
        return d.innerHTML;
    }

    function loadSavedRoute(id) {
        const routes = loadSavedRoutes();
        const saved = routes.find(r => r.id === id);
        if (!saved) return;

        const path = saved.points.map(p => new google.maps.LatLng(p.lat, p.lng));
        lastRoutePoints = path;
        activeLoadedId = id;
        lastRouteData = saved;

        clearRoute();
        currentPolyline = new google.maps.Polyline({
            path, geodesic:true, strokeColor:'#333', strokeWeight:4, map
        });

        // Re-add markers
        currentMarkers.push(new google.maps.Marker({
            position: path[0], map,
            icon: { path: google.maps.SymbolPath.CIRCLE, scale:8, fillColor:'#16a34a', fillOpacity:1, strokeColor:'#fff', strokeWeight:2 },
            label: { text:'START', color:'#fff', fontSize:'9px', fontWeight:'bold' }
        }));
        if (saved.routeType !== 'loop') {
            currentMarkers.push(new google.maps.Marker({
                position: path[path.length-1], map,
                icon: { path: google.maps.SymbolPath.CIRCLE, scale:8, fillColor:'#e53e3e', fillOpacity:1, strokeColor:'#fff', strokeWeight:2 },
                label: { text:'END', color:'#fff', fontSize:'9px', fontWeight:'bold' }
            }));
        }

        const bounds = new google.maps.LatLngBounds();
        path.forEach(p => bounds.extend(p));
        map.fitBounds(bounds, 60);

        showRouteInfo(saved);
        document.getElementById('savedDrawer').classList.remove('open');

        if (!hasGeneratedRoute) { generateBtn.textContent='New Route'; hasGeneratedRoute=true; }
    }

    function deleteSavedRoute(id) {
        let routes = loadSavedRoutes();
        routes = routes.filter(r => r.id !== id);
        persistRoutes(routes);
        if (activeLoadedId === id) {
            activeLoadedId = null;
            if (lastRouteData) showRouteInfo(lastRouteData);
        }
        renderSavedList();
    }

    window.onload = initMap;
    </script>
</body>
</html>
