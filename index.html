<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Running Route Generator</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            overflow: hidden;
        }
        #map { width:100vw; height:100vh; position:fixed; top:0; left:0; z-index:1; }

        .controls-panel {
            position:fixed; bottom:0; left:0; right:0; z-index:10;
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(10px);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
        }
        .controls-panel.collapsed { transform: translateY(calc(100% - 50px)); }

        .controls-header {
            padding:12px 20px;
            display:flex; justify-content:space-between; align-items:center;
            cursor:pointer; border-bottom: 1px solid #e8e8e8;
        }
        .controls-panel.collapsed .controls-header { border-bottom:none; }
        .controls-title { font-weight:600; color:#333; font-size:0.9em; text-transform:uppercase; letter-spacing:0.5px; }
        .collapse-icon {
            width:24px; height:24px;
            display:flex; align-items:center; justify-content:center;
            color:#666; transition: transform 0.3s ease;
        }
        .controls-panel.collapsed .collapse-icon { transform:rotate(180deg); }

        .controls-content { padding:12px 20px 15px; max-height:33vh; overflow-y:auto; }
        .controls-grid {
            max-width:1600px; margin:0 auto;
            display:grid;
            grid-template-columns: auto auto auto auto 1fr auto;
            gap:12px; align-items:start;
        }

        .control-group { background:#f8f9fa; padding:10px 12px; border-radius:10px; }
        .control-group-title { font-size:0.65em; font-weight:600; color:#666; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px; }

        .toggle-container { display:flex; gap:4px; background:#e8e8e8; padding:2px; border-radius:8px; }
        .toggle-btn {
            flex:1; padding:6px 10px; background:transparent; border:none;
            border-radius:6px; font-weight:600; font-size:0.75em; cursor:pointer;
            color:#666; text-transform:uppercase; letter-spacing:0.3px; white-space:nowrap;
            transition: all 0.2s;
        }
        .toggle-btn.active { background:#fff; color:#333; box-shadow:0 2px 6px rgba(0,0,0,0.1); }

        .terrain-chips { display:flex; flex-wrap:wrap; gap:5px; }
        .terrain-chip {
            padding:6px 10px; background:#fff; border:2px solid #e8e8e8;
            border-radius:20px; cursor:pointer; font-weight:600; font-size:0.7em; color:#666;
            display:flex; align-items:center; gap:4px; transition:all 0.2s;
            user-select: none; -webkit-user-select: none;
        }
        .terrain-chip:hover { border-color:#ccc; }
        .terrain-chip.active { background:#333; color:#fff; border-color:#333; }

        select {
            width:100%; padding:10px 12px; background:#fff; border:2px solid #e8e8e8;
            border-radius:8px; font-size:0.8em; font-weight:500; color:#333; cursor:pointer;
        }

        input[type="range"] { width:100%; height:5px; border-radius:5px; background:#e0e0e0; outline:none; -webkit-appearance:none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance:none; width:16px; height:16px; border-radius:50%; background:#333; cursor:pointer; }
        .slider-with-value { display:flex; align-items:center; gap:10px; }
        .slider-with-value input[type="range"] { flex:1; }
        .slider-value { font-size:1.3em; font-weight:700; color:#333; min-width:65px; text-align:right; }
        .slider-value .unit { font-size:0.55em; font-weight:500; color:#999; margin-left:3px; }

        .btn {
            width:100%; padding:12px 16px; background:#333; color:#fff; border:none;
            border-radius:10px; font-size:0.85em; font-weight:600; cursor:pointer;
            text-transform:uppercase; letter-spacing:0.5px; transition:all 0.2s;
        }
        .btn:hover { background:#000; }
        .btn:disabled { opacity:0.5; cursor:not-allowed; }

        .top-btn {
            position:fixed; left:20px;
            background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
            border:none; width:48px; height:48px; border-radius:12px;
            box-shadow:0 4px 20px rgba(0,0,0,0.15);
            cursor:pointer; display:flex; align-items:center; justify-content:center;
            z-index:10; font-size:1.3em; transition:all 0.2s;
        }
        .top-btn:hover { background:#fff; transform:scale(1.05); }
        .top-btn .badge {
            position:absolute; top:4px; right:4px;
            background:#333; color:#fff; font-size:0.42em; font-weight:700;
            min-width:16px; height:16px; border-radius:8px;
            display:flex; align-items:center; justify-content:center;
        }
        #savedBtn { top:20px; }
        #exploreBtn { top:80px; }
        #buildBtn { top:140px; }
        #discoverBtn { top:200px; }

        .drawer {
            position:fixed; top:0; left:0; width:380px; height:100vh;
            background:rgba(255,255,255,0.97); backdrop-filter:blur(14px);
            box-shadow:4px 0 24px rgba(0,0,0,0.18);
            z-index:20; transform:translateX(-100%);
            transition:transform 0.3s cubic-bezier(.4,0,.2,1);
            display:flex; flex-direction:column;
        }
        .drawer.open { transform:translateX(0); }

        .drawer-header {
            display:flex; justify-content:space-between; align-items:center;
            padding:20px 18px 14px; border-bottom:1px solid #eee;
        }
        .drawer-header h3 { font-size:1em; font-weight:600; color:#333; text-transform:uppercase; letter-spacing:0.5px; }
        .drawer-close {
            background:none; border:none; color:#666; cursor:pointer;
            font-size:1.4em; padding:2px 6px; border-radius:6px;
        }

        .drawer-content { flex:1; overflow-y:auto; padding:10px 12px; }

        .explore-tabs {
            display:flex; gap:4px; padding:0 12px 10px; border-bottom:1px solid #eee;
        }
        .explore-tab {
            flex:1; padding:8px; background:transparent; border:none;
            border-radius:8px; font-weight:600; font-size:0.75em; color:#666;
            cursor:pointer; text-transform:uppercase; transition:all 0.2s;
        }
        .explore-tab.active { background:#f0f0f0; color:#333; }

        .route-card {
            background:#fff; border-radius:12px; padding:12px;
            margin-bottom:10px; border:1px solid #e8e8e8;
            cursor:pointer; transition:all 0.2s;
        }
        .route-card:hover { border-color:#ccc; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
        .route-card-title { font-weight:600; font-size:0.9em; color:#333; margin-bottom:8px; }
        .route-card-stats {
            display:flex; gap:12px; font-size:0.75em; color:#666;
        }

        .info-card {
            position:fixed; top:20px; right:20px;
            background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
            padding:16px 18px; border-radius:15px;
            box-shadow:0 8px 32px rgba(0,0,0,0.15);
            z-index:10; min-width:260px; display:none;
        }
        .info-card.visible { display:block; }

        .info-actions { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:14px; }
        .info-actions .btn { padding:10px; font-size:0.75em; }

        .build-overlay {
            position:fixed; top:20px; left:50%; transform:translateX(-50%);
            background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
            padding:16px 20px; border-radius:15px;
            box-shadow:0 8px 32px rgba(0,0,0,0.15);
            z-index:15; display:none; max-width:400px; width:90%;
        }
        .build-overlay.active { display:block; }

        .discover-filters { padding:12px; border-bottom:1px solid #eee; }
        .filter-row { display:flex; gap:8px; margin-bottom:8px; }
        .filter-row input { flex:1; padding:8px; border:2px solid #e8e8e8; border-radius:8px; }

        .loading { text-align:center; padding:8px; color:#666; font-size:0.75em; }
        .error { background:#fff5f5; color:#e53e3e; padding:8px; border-radius:8px; font-size:0.75em; }
        .success { background:#f0fdf4; color:#16a34a; padding:8px; border-radius:8px; font-size:0.75em; }

        @media (max-width:768px) {
            .controls-grid { grid-template-columns:1fr; }
            .drawer { width:85vw; }
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <button class="top-btn" id="savedBtn" onclick="toggleDrawer('saved')">üóÇÔ∏è<span class="badge" id="savedBadge" style="display:none;"></span></button>
    <button class="top-btn" id="exploreBtn" onclick="toggleDrawer('explore')">üåç</button>
    <button class="top-btn" id="buildBtn" onclick="startBuildMode()">‚úèÔ∏è</button>
    <button class="top-btn" id="discoverBtn" onclick="toggleDrawer('discover')">üîç</button>

    <div class="drawer" id="savedDrawer">
        <div class="drawer-header">
            <h3>My Routes</h3>
            <button class="drawer-close" onclick="closeDrawers()">√ó</button>
        </div>
        <div class="drawer-content" id="savedList"></div>
    </div>

    <div class="drawer" id="exploreDrawer">
        <div class="drawer-header">
            <h3>Explore Routes</h3>
            <button class="drawer-close" onclick="closeDrawers()">√ó</button>
        </div>
        <div class="explore-tabs">
            <button class="explore-tab active" data-tab="popular">Popular</button>
            <button class="explore-tab" data-tab="community">Community</button>
            <button class="explore-tab" data-tab="nearby">Nearby</button>
        </div>
        <div class="drawer-content" id="exploreList"></div>
    </div>

    <div class="drawer" id="discoverDrawer">
        <div class="drawer-header">
            <h3>Discover Routes</h3>
            <button class="drawer-close" onclick="closeDrawers()">√ó</button>
        </div>
        <div class="discover-filters">
            <div class="filter-row">
                <input type="number" id="discoverRadius" placeholder="Radius (km)" value="10" min="1" max="50" />
            </div>
            <button class="btn" onclick="searchNearbyRoutes()" style="padding:8px; font-size:0.75em;">üîç Search</button>
        </div>
        <div class="drawer-content" id="discoverList"></div>
    </div>

    <div id="routeInfo"></div>

    <div class="build-overlay" id="buildOverlay">
        <h4 style="font-size:0.9em; font-weight:600; margin-bottom:12px;">Build Custom Route</h4>
        <p style="font-size:0.8em; color:#666; margin-bottom:12px;">Click/tap on the map to add waypoints</p>
        <div id="buildWaypointCount" style="font-size:0.85em; font-weight:600; color:#10b981; margin-bottom:12px;">0 waypoints</div>
        <div style="display:flex; gap:8px;">
            <button class="btn" onclick="cancelBuildMode()" style="background:#f0f0f0; color:#333; padding:8px; font-size:0.75em;">Cancel</button>
            <button class="btn" onclick="finishBuildMode()" style="padding:8px; font-size:0.75em;">Finish</button>
        </div>
    </div>

    <div class="controls-panel" id="controlsPanel">
        <div class="controls-header" onclick="toggleControls()">
            <div class="controls-title">Route Settings</div>
            <div class="collapse-icon">
                <svg width="20" height="20" viewBox="0 0 20 20"><path d="M5 7.5l5 5 5-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
            </div>
        </div>
        <div class="controls-content">
            <div class="controls-grid">
                <div class="control-group">
                    <div class="control-group-title">Mode</div>
                    <div class="toggle-container">
                        <button class="toggle-btn active" id="distanceToggle">Distance</button>
                        <button class="toggle-btn" id="timeToggle">Time</button>
                    </div>
                </div>

                <div class="control-group" id="distanceGroup">
                    <div class="control-group-title">Distance</div>
                    <div class="slider-with-value">
                        <input type="range" id="distance" min="1" max="20" value="5" step="0.1">
                        <div class="slider-value"><span id="distanceValue">5.0</span><span class="unit">km</span></div>
                    </div>
                </div>

                <div class="control-group" id="timeGroup" style="display:none;">
                    <div class="control-group-title">Duration</div>
                    <div class="slider-with-value">
                        <input type="range" id="time" min="10" max="120" value="30" step="1">
                        <div class="slider-value"><span id="timeValue">30</span><span class="unit">min</span></div>
                    </div>
                </div>

                <div class="control-group">
                    <div class="control-group-title">Route Type</div>
                    <select id="routeType">
                        <option value="oneWay">One Way</option>
                        <option value="returnSame" selected>Out & Back</option>
                        <option value="loop">Loop</option>
                    </select>
                </div>

                <div class="control-group">
                    <div class="control-group-title">Terrain</div>
                    <div class="terrain-chips" id="terrainChips">
                        <div class="terrain-chip" data-terrain="park">üå≥ Park</div>
                        <div class="terrain-chip" data-terrain="waterside">üåä Water</div>
                        <div class="terrain-chip" data-terrain="hill">‚õ∞Ô∏è Hill</div>
                        <div class="terrain-chip" data-terrain="scenic">üåÖ Scenic</div>
                    </div>
                </div>

                <div class="control-group">
                    <button class="btn" id="generateBtn">Generate Route</button>
                    <div id="message"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPgzqvSqNMXp3jxTLh4TbyT0IwJd46dbA&libraries=geometry,places"></script>
    <script>
    // Global state
    let map, directionsRenderer, directionsService, placesService;
    let userLocation = { lat:-33.8915, lng:151.2767, name:'Bondi Beach' };
    let selectedTerrain = null;
    let currentMode = 'distance';
    let lastRouteData = null;
    let buildModeActive = false;
    let buildWaypoints = [];
    let buildMarkers = [];
    let buildPolyline = null;
    let mapClickListener = null;
    let currentExploreTab = 'popular';

    const STORAGE_KEY = 'runningRoutes_saved';
    const SHARED_KEY = 'runningRoutes_shared';

    // Initialize
    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: userLocation,
            zoom: 15,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: false
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true,
            polylineOptions: { strokeColor: '#333', strokeWeight: 4 }
        });

        placesService = new google.maps.places.PlacesService(map);

        // Get user location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                pos => {
                    userLocation = {
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                        name: 'Your location'
                    };
                    map.setCenter(userLocation);
                },
                () => console.log('Using default location')
            );
        }

        setupEventListeners();
        renderSavedList();
        seedDemoRoutes();
    }

    // Event listeners
    function setupEventListeners() {
        // Terrain chips - FIXED
        document.querySelectorAll('.terrain-chip').forEach(chip => {
            chip.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                if (this.classList.contains('active')) {
                    this.classList.remove('active');
                    selectedTerrain = null;
                } else {
                    document.querySelectorAll('.terrain-chip').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    selectedTerrain = this.dataset.terrain;
                }
                console.log('Terrain selected:', selectedTerrain);
            });
        });

        // Mode toggle
        document.getElementById('distanceToggle').addEventListener('click', () => {
            currentMode = 'distance';
            document.getElementById('distanceToggle').classList.add('active');
            document.getElementById('timeToggle').classList.remove('active');
            document.getElementById('distanceGroup').style.display = 'block';
            document.getElementById('timeGroup').style.display = 'none';
        });

        document.getElementById('timeToggle').addEventListener('click', () => {
            currentMode = 'time';
            document.getElementById('timeToggle').classList.add('active');
            document.getElementById('distanceToggle').classList.remove('active');
            document.getElementById('distanceGroup').style.display = 'none';
            document.getElementById('timeGroup').style.display = 'block';
        });

        // Sliders
        document.getElementById('distance').addEventListener('input', e => {
            document.getElementById('distanceValue').textContent = parseFloat(e.target.value).toFixed(1);
        });

        document.getElementById('time').addEventListener('input', e => {
            document.getElementById('timeValue').textContent = e.target.value;
        });

        // Generate button
        document.getElementById('generateBtn').addEventListener('click', generateRoute);

        // Explore tabs
        document.querySelectorAll('.explore-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.explore-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentExploreTab = this.dataset.tab;
                renderExploreList();
            });
        });
    }

    // FIXED: Generate route - WALKING ONLY, no transit
    async function generateRoute() {
        const messageDiv = document.getElementById('message');
        const btn = document.getElementById('generateBtn');

        try {
            btn.disabled = true;
            messageDiv.innerHTML = '<div class="loading">üó∫Ô∏è Generating walking route...</div>';

            const distance = currentMode === 'distance'
                ? parseFloat(document.getElementById('distance').value)
                : (parseInt(document.getElementById('time').value) / 60) * (60 / 5); // assume 5 min/km pace

            const routeType = document.getElementById('routeType').value;

            let result;
            if (routeType === 'loop') {
                result = await generateLoop(userLocation, distance, selectedTerrain);
            } else {
                result = await generateDirectRoute(userLocation, distance, routeType, selectedTerrain);
            }

            directionsRenderer.setDirections(result);
            
            const points = extractPoints(result);
            lastRouteData = {
                distance,
                routeType,
                terrain: selectedTerrain,
                location: { ...userLocation },
                points: points.map(p => ({ lat: p.lat(), lng: p.lng() })),
                createdAt: Date.now()
            };

            showRouteInfo(lastRouteData);
            messageDiv.innerHTML = '<div class="success">‚úì Route generated!</div>';
            setTimeout(() => { messageDiv.innerHTML = ''; }, 2000);

        } catch (err) {
            console.error('Route generation error:', err);
            messageDiv.innerHTML = `<div class="error">‚ö†Ô∏è ${err.message}</div>`;
        } finally {
            btn.disabled = false;
        }
    }

    // FIXED: Loop generation - WALKING ONLY
    function generateLoop(origin, distanceKm, terrain) {
        return new Promise((resolve, reject) => {
            const radius = (distanceKm * 1000) / (2 * Math.PI);
            const waypoints = [];

            // Generate 2 waypoints in opposite directions
            for (let i = 0; i < 2; i++) {
                const angle = (i / 2) * 360 + (Math.random() - 0.5) * 60;
                const r = radius * (0.9 + Math.random() * 0.2);
                waypoints.push({
                    location: google.maps.geometry.spherical.computeOffset(
                        new google.maps.LatLng(origin.lat, origin.lng),
                        r,
                        angle
                    ),
                    stopover: false
                });
            }

            directionsService.route({
                origin: new google.maps.LatLng(origin.lat, origin.lng),
                destination: new google.maps.LatLng(origin.lat, origin.lng),
                waypoints: waypoints,
                travelMode: google.maps.TravelMode.WALKING, // WALKING ONLY
                optimizeWaypoints: true
            }, (res, status) => {
                if (status === 'OK') {
                    resolve(res);
                } else {
                    reject(new Error('Could not generate loop route'));
                }
            });
        });
    }

    // FIXED: Direct route - WALKING ONLY
    function generateDirectRoute(origin, distanceKm, routeType, terrain) {
        return new Promise((resolve, reject) => {
            const metres = routeType === 'returnSame' ? distanceKm * 500 : distanceKm * 1000;
            
            // Random direction
            const heading = Math.random() * 360;
            const dest = google.maps.geometry.spherical.computeOffset(
                new google.maps.LatLng(origin.lat, origin.lng),
                metres,
                heading
            );

            directionsService.route({
                origin: new google.maps.LatLng(origin.lat, origin.lng),
                destination: routeType === 'returnSame' 
                    ? new google.maps.LatLng(origin.lat, origin.lng)
                    : dest,
                waypoints: routeType === 'returnSame' ? [{ location: dest, stopover: false }] : [],
                travelMode: google.maps.TravelMode.WALKING, // WALKING ONLY
            }, (res, status) => {
                if (status === 'OK') {
                    resolve(res);
                } else {
                    reject(new Error('Could not generate route'));
                }
            });
        });
    }

    function extractPoints(result) {
        const points = [];
        result.routes[0].legs.forEach(leg => {
            leg.steps.forEach(step => {
                step.path.forEach(pt => points.push(pt));
            });
        });
        return points;
    }

    // FIXED: Discover nearby routes using Places API
    function searchNearbyRoutes() {
        const radius = (document.getElementById('discoverRadius').value || 10) * 1000; // km to m
        const listDiv = document.getElementById('discoverList');
        
        listDiv.innerHTML = '<div class="loading">üîç Searching for running routes nearby...</div>';

        const request = {
            location: new google.maps.LatLng(userLocation.lat, userLocation.lng),
            radius: radius,
            keyword: 'running trail park path walking route'
        };

        placesService.nearbySearch(request, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
                renderDiscoverResults(results.slice(0, 20));
            } else {
                listDiv.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">No routes found nearby. Try increasing the radius.</div>';
            }
        });
    }

    function renderDiscoverResults(places) {
        const listDiv = document.getElementById('discoverList');
        
        const html = places.map(place => {
            const distance = google.maps.geometry.spherical.computeDistanceBetween(
                new google.maps.LatLng(userLocation.lat, userLocation.lng),
                place.geometry.location
            ) / 1000;

            return `
                <div class="route-card" onclick="showPlaceRoute('${place.place_id}')">
                    <div class="route-card-title">üìç ${escapeHtml(place.name)}</div>
                    <div class="route-card-stats">
                        <span>üìè ${distance.toFixed(1)} km away</span>
                        ${place.rating ? `<span>‚≠ê ${place.rating}</span>` : ''}
                    </div>
                </div>
            `;
        }).join('');

        listDiv.innerHTML = html || '<div style="padding:20px; text-align:center; color:#999;">No results</div>';
    }

    function showPlaceRoute(placeId) {
        placesService.getDetails({ placeId: placeId }, (place, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                map.setCenter(place.geometry.location);
                map.setZoom(16);
                
                new google.maps.Marker({
                    position: place.geometry.location,
                    map: map,
                    title: place.name
                });

                closeDrawers();
            }
        });
    }

    // Build mode - FIXED for touch
    function startBuildMode() {
        buildModeActive = true;
        buildWaypoints = [];
        buildMarkers = [];
        
        if (buildPolyline) {
            buildPolyline.setMap(null);
            buildPolyline = null;
        }

        document.getElementById('buildOverlay').classList.add('active');
        document.getElementById('buildWaypointCount').textContent = '0 waypoints';
        closeDrawers();

        // FIXED: Proper listener management
        mapClickListener = google.maps.event.addListener(map, 'click', function(e) {
            if (!buildModeActive) return;
            
            const latLng = e.latLng;
            buildWaypoints.push(latLng);

            const marker = new google.maps.Marker({
                position: latLng,
                map: map,
                label: {
                    text: String(buildWaypoints.length),
                    color: '#fff',
                    fontWeight: 'bold'
                },
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 12,
                    fillColor: '#10b981',
                    fillOpacity: 1,
                    strokeColor: '#fff',
                    strokeWeight: 2
                }
            });
            buildMarkers.push(marker);

            // Update polyline
            if (buildPolyline) buildPolyline.setMap(null);
            buildPolyline = new google.maps.Polyline({
                path: buildWaypoints,
                strokeColor: '#10b981',
                strokeWeight: 3,
                map: map
            });

            document.getElementById('buildWaypointCount').textContent = 
                `${buildWaypoints.length} waypoint${buildWaypoints.length === 1 ? '' : 's'}`;
        });
    }

    function cancelBuildMode() {
        buildModeActive = false;
        document.getElementById('buildOverlay').classList.remove('active');

        if (mapClickListener) {
            google.maps.event.removeListener(mapClickListener);
            mapClickListener = null;
        }

        if (buildPolyline) {
            buildPolyline.setMap(null);
            buildPolyline = null;
        }

        buildMarkers.forEach(m => m.setMap(null));
        buildMarkers = [];
        buildWaypoints = [];
    }

    function finishBuildMode() {
        if (buildWaypoints.length < 2) {
            alert('Add at least 2 waypoints');
            return;
        }

        // Calculate distance
        let totalDist = 0;
        for (let i = 0; i < buildWaypoints.length - 1; i++) {
            totalDist += google.maps.geometry.spherical.computeDistanceBetween(
                buildWaypoints[i],
                buildWaypoints[i + 1]
            );
        }
        const distanceKm = totalDist / 1000;

        // Create route with Directions API to snap to roads
        const waypoints = buildWaypoints.slice(1, -1).map(w => ({ location: w, stopover: false }));
        
        directionsService.route({
            origin: buildWaypoints[0],
            destination: buildWaypoints[buildWaypoints.length - 1],
            waypoints: waypoints,
            travelMode: google.maps.TravelMode.WALKING // WALKING ONLY
        }, (result, status) => {
            if (status === 'OK') {
                directionsRenderer.setDirections(result);
                
                const points = extractPoints(result);
                lastRouteData = {
                    distance: distanceKm,
                    routeType: 'custom',
                    location: { name: 'Custom Route' },
                    points: points.map(p => ({ lat: p.lat(), lng: p.lng() })),
                    custom: true,
                    createdAt: Date.now()
                };

                showRouteInfo(lastRouteData);
                cancelBuildMode();
            } else {
                alert('Could not create route along roads. Try placing waypoints closer together.');
            }
        });
    }

    // UI functions
    function toggleControls() {
        document.getElementById('controlsPanel').classList.toggle('collapsed');
    }

    function toggleDrawer(which) {
        const drawers = ['savedDrawer', 'exploreDrawer', 'discoverDrawer'];
        const targetId = which + 'Drawer';

        drawers.forEach(id => {
            const drawer = document.getElementById(id);
            if (id === targetId) {
                drawer.classList.toggle('open');
            } else {
                drawer.classList.remove('open');
            }
        });

        if (which === 'explore') {
            renderExploreList();
        } else if (which === 'discover') {
            searchNearbyRoutes();
        }
    }

    function closeDrawers() {
        document.querySelectorAll('.drawer').forEach(d => d.classList.remove('open'));
    }

    function showRouteInfo(data) {
        const html = `
            <div class="info-card visible">
                <h3 style="margin-bottom:12px; font-size:0.9em;">${escapeHtml(data.name || 'Route Details')}</h3>
                <div style="font-size:0.8em; margin-bottom:12px;">
                    <div style="margin-bottom:4px;">üìè Distance: ${data.distance.toFixed(1)} km</div>
                    <div style="margin-bottom:4px;">üìç Type: ${data.routeType === 'custom' ? 'Custom' : data.routeType === 'loop' ? 'Loop' : data.routeType === 'returnSame' ? 'Out & Back' : 'One Way'}</div>
                    ${data.terrain ? `<div>üå≤ Terrain: ${data.terrain}</div>` : ''}
                </div>
                <div class="info-actions">
                    <button class="btn" onclick="saveRoute()">üíæ Save</button>
                    <button class="btn" onclick="shareRoute()">üîó Share</button>
                </div>
            </div>
        `;
        document.getElementById('routeInfo').innerHTML = html;
    }

    function saveRoute() {
        if (!lastRouteData) return;

        const routes = loadSavedRoutes();
        const saved = {
            id: Date.now().toString(),
            name: prompt('Route name:', `Route ${routes.length + 1}`) || `Route ${routes.length + 1}`,
            ...lastRouteData
        };

        routes.unshift(saved);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(routes));

        renderSavedList();
        alert('Route saved!');
    }

    function shareRoute() {
        if (!lastRouteData) return;

        const encoded = btoa(JSON.stringify(lastRouteData));
        const url = `${window.location.origin}${window.location.pathname}?route=${encoded}`;
        
        navigator.clipboard.writeText(url).then(() => {
            alert('Share link copied to clipboard!');
        });

        // Also save to shared routes
        const shared = loadSharedRoutes();
        shared[lastRouteData.createdAt] = {
            ...lastRouteData,
            likes: 0,
            views: 0
        };
        localStorage.setItem(SHARED_KEY, JSON.stringify(shared));
    }

    function renderSavedList() {
        const routes = loadSavedRoutes();
        const listDiv = document.getElementById('savedList');

        if (routes.length === 0) {
            listDiv.innerHTML = '<div style="padding:40px 20px; text-align:center; color:#999; font-size:0.85em;">No saved routes yet</div>';
            document.getElementById('savedBadge').style.display = 'none';
            return;
        }

        document.getElementById('savedBadge').style.display = 'flex';
        document.getElementById('savedBadge').textContent = routes.length;

        listDiv.innerHTML = routes.map(r => `
            <div class="route-card" onclick="loadRoute('${r.id}')">
                <div class="route-card-title">${escapeHtml(r.name)}</div>
                <div class="route-card-stats">
                    <span>üìè ${r.distance.toFixed(1)} km</span>
                    <span>üìÖ ${new Date(r.createdAt).toLocaleDateString()}</span>
                </div>
            </div>
        `).join('');
    }

    function renderExploreList() {
        const shared = loadSharedRoutes();
        const routes = Object.values(shared);
        const listDiv = document.getElementById('exploreList');

        if (routes.length === 0) {
            listDiv.innerHTML = '<div style="padding:40px 20px; text-align:center; color:#999; font-size:0.85em;">No community routes yet</div>';
            return;
        }

        listDiv.innerHTML = routes.map(r => `
            <div class="route-card">
                <div class="route-card-title">üìç ${escapeHtml(r.name || 'Community Route')}</div>
                <div class="route-card-stats">
                    <span>üìè ${r.distance.toFixed(1)} km</span>
                    <span>‚ù§Ô∏è ${r.likes || 0}</span>
                </div>
            </div>
        `).join('');
    }

    function loadSavedRoutes() {
        try {
            return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        } catch {
            return [];
        }
    }

    function loadSharedRoutes() {
        try {
            return JSON.parse(localStorage.getItem(SHARED_KEY)) || {};
        } catch {
            return {};
        }
    }

    function loadRoute(id) {
        const routes = loadSavedRoutes();
        const route = routes.find(r => r.id === id);
        if (!route) return;

        const path = route.points.map(p => new google.maps.LatLng(p.lat, p.lng));
        
        new google.maps.Polyline({
            path: path,
            strokeColor: '#333',
            strokeWeight: 4,
            map: map
        });

        const bounds = new google.maps.LatLngBounds();
        path.forEach(p => bounds.extend(p));
        map.fitBounds(bounds);

        lastRouteData = route;
        showRouteInfo(route);
        closeDrawers();
    }

    function seedDemoRoutes() {
        const shared = loadSharedRoutes();
        if (Object.keys(shared).length > 0) return;

        const demo = {
            '1': {
                name: 'Bondi to Bronte Coastal Walk',
                distance: 3.5,
                routeType: 'oneWay',
                terrain: 'scenic',
                location: { lat: -33.8915, lng: 151.2767 },
                points: [{ lat: -33.8915, lng: 151.2767 }, { lat: -33.9050, lng: 151.2650 }],
                likes: 47,
                views: 203,
                createdAt: Date.now() - 86400000 * 7
            }
        };

        localStorage.setItem(SHARED_KEY, JSON.stringify(demo));
    }

    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // Check for shared route in URL
    window.addEventListener('load', () => {
        const params = new URLSearchParams(window.location.search);
        const routeData = params.get('route');
        if (routeData) {
            try {
                const route = JSON.parse(atob(routeData));
                lastRouteData = route;
                
                const path = route.points.map(p => new google.maps.LatLng(p.lat, p.lng));
                new google.maps.Polyline({
                    path: path,
                    strokeColor: '#333',
                    strokeWeight: 4,
                    map: map
                });

                const bounds = new google.maps.LatLngBounds();
                path.forEach(p => bounds.extend(p));
                map.fitBounds(bounds);

                showRouteInfo(route);
            } catch (e) {
                console.error('Invalid shared route');
            }
        }
    });

    window.onload = initMap;
    </script>
</body>
</html>
